<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oficial de Servi√ßo - Dashboard</title>

<!-- Favicon da Marinha -->
<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
/* ==========================================================
   VISUAL PREMIUM 2025 ‚Äî OFICIAL DE SERVI√áO (ASSINATURAS AO LADO)
========================================================== */
:root {
  --cor-primaria: #004aad;
  --cor-primaria-hover: #003b8e;
  --cor-fundo: #f5f7fa;
  --cor-texto: #1f2937;
  --cor-card: #ffffff;
  --cor-borda: #d1d5db;
  --cor-secundaria: #e2e8f0;
  --cor-sucesso: #16a34a;
  --cor-erro: #dc2626;
  --cor-aviso: #f59e0b;
  --cor-fora: rgba(255, 0, 0, 0.06);
  --cor-assinaturas: #f8fafc;
}

@media (prefers-color-scheme: dark) {
  :root {
    --cor-fundo: #0b1120;
    --cor-card: #111827;
    --cor-texto: #e5e7eb;
    --cor-borda: #1f2937;
    --cor-secundaria: #1e293b;
    --cor-fora: rgba(255, 0, 0, 0.15);
    --cor-assinaturas: #1a2438;
  }
}

* {
  box-sizing: border-box;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  margin: 0;
  padding: 0;
}

body {
  background: var(--cor-fundo);
  color: var(--cor-texto);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  padding: 30px 15px;
  font-size: 1.05rem;
}

.container {
  width: 100%;
  max-width: 1350px;
  background: var(--cor-card);
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  padding: 35px;
}

/* Cabe√ßalho */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 30px;
}
.logo-marinha {
  display: flex;
  align-items: center;
  gap: 14px;
}
.logo-marinha img {
  width: 64px;
  height: 64px;
}
header h1 {
  color: var(--cor-primaria);
  font-size: 1.8rem;
  font-weight: 700;
}
header button {
  background: var(--cor-secundaria);
  color: var(--cor-texto);
  border: none;
  padding: 12px 22px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.25s;
}
header button:hover {
  background: var(--cor-card);
}

/* T√≠tulos */
h2 {
  color: var(--cor-primaria);
  border-left: 5px solid var(--cor-primaria);
  padding-left: 12px;
  margin: 30px 0 12px;
  font-size: 1.4rem;
}

/* Formul√°rio */
.form-missao {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 30px;
}
.form-missao input[type="text"] {
  flex: 1 1 30%;
  min-width: 260px;
  padding: 14px;
  border: 1px solid var(--cor-borda);
  border-radius: 8px;
}
.form-missao input[type="text"]:focus {
  border-color: var(--cor-primaria);
  outline: none;
}
.form-missao label {
  width: 100%;
  font-size: 1rem;
  margin: 10px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.form-missao button[type="submit"] {
  background: var(--cor-primaria);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1.05rem;
  transition: 0.25s;
}
.form-missao button[type="submit"]:hover {
  background: var(--cor-primaria-hover);
}

/* Tabela */
.table-wrap {
  width: 100%;
  overflow-x: auto;
  border-radius: 10px;
  margin-top: 15px;
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1000px;
  font-size: 1rem;
}
thead {
  background: var(--cor-primaria);
  color: white;
}
th, td {
  text-align: left;
  padding: 14px 16px;
  border-bottom: 1px solid var(--cor-borda);
  vertical-align: middle;
}
tbody tr:hover {
  background: rgba(0,74,173,0.05);
}

/* Bot√µes */
button.aprovar,
button.negar {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  transition: 0.25s;
  margin: 3px 0;
}
button.aprovar {
  background: var(--cor-sucesso);
  color: white;
}
button.aprovar:hover { background: #15803d; }
button.negar {
  background: var(--cor-erro);
  color: white;
}
button.negar:hover { background: #b91c1c; }

/* Coluna de Assinaturas */
.assinaturas-coluna {
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: var(--cor-assinaturas);
  padding: 8px 10px;
  border-radius: 6px;
  font-size: 0.9rem;
  line-height: 1.3;
}
.assinaturas-coluna b {
  color: var(--cor-primaria);
}

/* Responsividade */
@media (max-width: 768px) {
  .form-missao {
    flex-direction: column;
  }
  .form-missao input[type="text"] {
    width: 100%;
  }
  header {
    flex-direction: column;
    align-items: flex-start;
  }
  table { min-width: 800px; }
}
</style>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, addDoc, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

let usuarioAtual = null;

// =============================
// üîí Prote√ß√£o de acesso
// =============================
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    usuarioAtual = user;
    carregarMissoes();
    iniciarInatividade();
  }
});

// =============================
// ‚è∞ Logout autom√°tico
// =============================
let timerInativo;
function iniciarInatividade() {
  const resetar = () => {
    clearTimeout(timerInativo);
    timerInativo = setTimeout(() => {
      alert("Sess√£o encerrada por inatividade.");
      signOut(auth);
      window.location.href = "index.html";
    }, 10 * 60 * 1000);
  };
  ["click","mousemove","keydown"].forEach(evt => window.addEventListener(evt, resetar));
  resetar();
}

// =============================
// üö™ Logout manual
// =============================
window.logout = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

// =============================
// üîπ Atualiza√ß√£o em tempo real
// =============================
function carregarMissoes() {
  const tbody = document.getElementById("missoes-body");
  onSnapshot(collection(db, "viaturas_missao"), (snapshot) => {
    tbody.innerHTML = "";
    snapshot.forEach((docItem) => {
      const data = docItem.data();
      const foraProg = data.fora_programacao
        ? "style='background:rgba(255,0,0,0.06); border-left:4px solid #dc3545;'"
        : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.missao || ""}
          ${data.fora_programacao ? "<span style='color:#dc3545;font-weight:bold;'> ‚ö† Fora da Programa√ß√£o</span>" : ""}
        </td>
        <td>${data.motorista || ""}</td>
        <td>${data.viatura || ""}</td>
        <td>${data.status || ""}</td>
        <td>${data.odometro_inicio || ""}</td>
        <td>${data.horario_inicio || ""}</td>
        <td>${data.odometro_fim || ""}</td>
        <td>${data.horario_fim || ""}</td>
        <td>
          <button class="aprovar" onclick="aprovar('${docItem.id}')">Aprovar</button>
          <button class="negar" onclick="negar('${docItem.id}')">Negar</button>
        </td>
        <td>
          <div class="assinaturas-coluna">
            <p><b>OSE:</b> ${data.assinatura_ose || "-"}</p>
            <p><b>Enc:</b> ${data.assinatura_encarregado || "-"}</p>
            <p><b>Chefe:</b> ${data.assinatura_chedep || "-"}</p>
            <p><b>P3:</b> ${data.assinatura_p3 || "-"}</p>
          </div>
        </td>
      `;
      tr.setAttribute("class", data.fora_programacao ? "fora-prog" : "");
      tbody.appendChild(tr);
    });
  });
}

// =============================
// üßæ Criar miss√£o
// =============================
window.criarMissao = async () => {
  const missao = document.getElementById("missao").value.trim();
  const motorista = document.getElementById("motorista").value.trim();
  const viatura = document.getElementById("viatura").value.trim();
  const foraProg = document.getElementById("foraProg").checked;

  if (!missao || !motorista || !viatura) {
    alert("‚ö†Ô∏è Preencha todos os campos antes de criar a miss√£o.");
    return;
  }

  try {
    await addDoc(collection(db, "viaturas_missao"), {
      missao,
      motorista,
      viatura,
      status: "Pendente",
      criado_por: usuarioAtual.email,
      fora_programacao: foraProg,
      criada_em: new Date().toLocaleString()
    });

    alert(foraProg ? "üö® Miss√£o fora da programa√ß√£o criada!" : "‚úÖ Miss√£o criada com sucesso!");
    document.querySelector(".form-missao").reset();
  } catch (erro) {
    console.error("Erro ao criar miss√£o:", erro);
    alert("‚ùå Erro ao criar miss√£o. Verifique a conex√£o e tente novamente.");
  }
};

// =============================
// ‚úçÔ∏è Assinar (Aprovar / Negar)
// =============================
window.aprovar = async (id) => {
  const agora = new Date().toLocaleString();
  await updateDoc(doc(db, "viaturas_missao", id), {
    status: "Aprovada",
    assinatura_ose: usuarioAtual.email,
    hora_assinatura_ose: agora
  });
  alert("‚úÖ Miss√£o aprovada e assinada pela OSE.");
};

window.negar = async (id) => {
  const agora = new Date().toLocaleString();
  await updateDoc(doc(db, "viaturas_missao", id), {
    status: "Negada",
    assinatura_ose: usuarioAtual.email,
    hora_assinatura_ose: agora
  });
  alert("üö´ Miss√£o negada e assinada pela OSE.");
};
</script>
</head>

<body>
<div class="container">
  <header>
    <div class="logo-marinha">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="Marinha do Brasil">
      <h1>Oficial de Servi√ßo</h1>
    </div>
    <button onclick="logout()">Sair</button>
  </header>

  <h2>Criar Nova Miss√£o</h2>
  <form onsubmit="event.preventDefault(); criarMissao();" class="form-missao">
    <input type="text" id="missao" placeholder="Descri√ß√£o da Miss√£o" required>
    <input type="text" id="motorista" placeholder="Motorista Respons√°vel" required>
    <input type="text" id="viatura" placeholder="Viatura (Ex: Parati E983-0987)" required>

    <label for="foraProg">
      <input type="checkbox" id="foraProg">
      <span>Miss√£o fora da programa√ß√£o</span>
    </label>

    <button type="submit">Criar Miss√£o</button>
  </form>

  <h2>Miss√µes Pendentes</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Miss√£o</th>
          <th>Motorista</th>
          <th>Viatura</th>
          <th>Status</th>
          <th>Od√¥metro In√≠cio</th>
          <th>Hor√°rio In√≠cio</th>
          <th>Od√¥metro Fim</th>
          <th>Hor√°rio Fim</th>
          <th>A√ß√µes</th>
          <th>Assinaturas</th>
        </tr>
      </thead>
      <tbody id="missoes-body"></tbody>
    </table>
  </div>
</div>
</body>
</html>
