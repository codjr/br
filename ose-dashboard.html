<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oficial de Servi√ßo - Dashboard</title>
<link rel="icon" type="image/svg+xml"
  href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">
<link rel="stylesheet" href="styleose.css"> <!-- seu CSS premium 2025 -->

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, addDoc, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

let usuarioAtual = null;

// =============================
// üîí Prote√ß√£o de acesso
// =============================
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    usuarioAtual = user;
    carregarMissoes();
    iniciarInatividade();
  }
});

// =============================
// ‚è∞ Logout autom√°tico
// =============================
let timerInativo;
function iniciarInatividade() {
  const resetar = () => {
    clearTimeout(timerInativo);
    timerInativo = setTimeout(() => {
      alert("Sess√£o encerrada por inatividade.");
      signOut(auth);
      window.location.href = "index.html";
    }, 10 * 60 * 1000);
  };
  ["click","mousemove","keydown"].forEach(evt => window.addEventListener(evt, resetar));
  resetar();
}

// =============================
// üö™ Logout manual
// =============================
window.logout = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

// =============================
// üîπ Atualiza√ß√£o em tempo real
// =============================
function carregarMissoes() {
  const tbody = document.getElementById("missoes-body");
  onSnapshot(collection(db, "viaturas_missao"), (snapshot) => {
    tbody.innerHTML = "";
    snapshot.forEach((docItem) => {
      const data = docItem.data();
      const foraProg = data.fora_programacao ? "style='background:rgba(255,0,0,0.06); border-left:4px solid #dc3545;'" : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.missao || ""}
          ${data.fora_programacao ? "<span style='color:#dc3545;font-weight:bold;'> ‚ö† Fora da Programa√ß√£o</span>" : ""}
          <br>
          <button class="toggle-assinaturas" onclick="toggleAssinaturas('${docItem.id}')">Ver Assinaturas</button>
        </td>
        <td>${data.motorista || ""}</td>
        <td>${data.viatura || ""}</td>
        <td>${data.status || ""}</td>
        <td>${data.odometro_inicio || ""}</td>
        <td>${data.horario_inicio || ""}</td>
        <td>${data.odometro_fim || ""}</td>
        <td>${data.horario_fim || ""}</td>
        <td>
          <button class="aprovar" onclick="aprovar('${docItem.id}')">Aprovar</button>
          <button class="negar" onclick="negar('${docItem.id}')">Negar</button>
        </td>
      `;

      const trAss = document.createElement("tr");
      trAss.classList.add("assinaturas-row");
      trAss.innerHTML = `
        <td colspan="9">
          <div id="assinaturas-${docItem.id}" class="assinaturas-conteudo">
            <p><b>Assinaturas:</b></p>
            <p>OSE: ${data.assinatura_ose || "-"}<br>
            Encarregado: ${data.assinatura_encarregado || "-"}<br>
            Chefe: ${data.assinatura_chedep || "-"}<br>
            P3: ${data.assinatura_p3 || "-"}</p>
          </div>
        </td>
      `;

      const linha = document.createElement("tbody");
      linha.innerHTML = `<tr ${foraProg}>${tr.innerHTML}</tr>`;
      linha.appendChild(trAss);
      tbody.appendChild(linha);
    });
  });
}

// =============================
// üîΩ Abrir/fechar assinaturas
// =============================
window.toggleAssinaturas = (id) => {
  const div = document.getElementById(`assinaturas-${id}`);
  div.classList.toggle("open");
};

// =============================
// üßæ Criar miss√£o
// =============================
window.criarMissao = async () => {
  const missao = document.getElementById("missao").value.trim();
  const motorista = document.getElementById("motorista").value.trim();
  const viatura = document.getElementById("viatura").value.trim();
  const foraProg = document.getElementById("foraProg").checked;

  if (!missao || !motorista || !viatura) {
    alert("‚ö†Ô∏è Preencha todos os campos antes de criar a miss√£o.");
    return;
  }

  try {
    await addDoc(collection(db, "viaturas_missao"), {
      missao,
      motorista,
      viatura,
      status: "Pendente",
      criado_por: usuarioAtual.email,
      fora_programacao: foraProg,
      criada_em: new Date().toLocaleString()
    });

    alert(foraProg ? "üö® Miss√£o fora da programa√ß√£o criada!" : "‚úÖ Miss√£o criada com sucesso!");
    document.querySelector(".form-missao").reset();
  } catch (erro) {
    console.error("Erro ao criar miss√£o:", erro);
    alert("‚ùå Erro ao criar miss√£o. Verifique a conex√£o e tente novamente.");
  }
};

// =============================
// ‚úçÔ∏è Assinar (Aprovar / Negar)
// =============================
window.aprovar = async (id) => {
  const agora = new Date().toLocaleString();
  await updateDoc(doc(db, "viaturas_missao", id), {
    status: "Aprovada",
    assinatura_ose: usuarioAtual.email,
    hora_assinatura_ose: agora
  });
  alert("‚úÖ Miss√£o aprovada e assinada pela OSE.");
};

window.negar = async (id) => {
  const agora = new Date().toLocaleString();
  await updateDoc(doc(db, "viaturas_missao", id), {
    status: "Negada",
    assinatura_ose: usuarioAtual.email,
    hora_assinatura_ose: agora
  });
  alert("üö´ Miss√£o negada e assinada pela OSE.");
};
</script>
</head>

<body>
<div class="container">
  <header>
    <div class="logo-marinha">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="Marinha do Brasil">
      <h1>Oficial de Servi√ßo</h1>
    </div>
    <button onclick="logout()">Sair</button>
  </header>

  <h2>Criar Nova Miss√£o</h2>
  <form onsubmit="event.preventDefault(); criarMissao();" class="form-missao">
    <input type="text" id="missao" placeholder="Descri√ß√£o da Miss√£o" required>
    <input type="text" id="motorista" placeholder="Motorista Respons√°vel" required>
    <input type="text" id="viatura" placeholder="Viatura (Ex: Parati E983-0987)" required>

    <label for="foraProg">
      <input type="checkbox" id="foraProg">
      <span>Miss√£o fora da programa√ß√£o</span>
    </label>

    <button type="submit">Criar Miss√£o</button>
  </form>

  <h2>Miss√µes Pendentes</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Miss√£o</th>
          <th>Motorista</th>
          <th>Viatura</th>
          <th>Status</th>
          <th>Od√¥metro In√≠cio</th>
          <th>Hor√°rio In√≠cio</th>
          <th>Od√¥metro Fim</th>
          <th>Hor√°rio Fim</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="missoes-body"></tbody>
    </table>
  </div>
</div>
</body>
</html>
