<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oficial de Servi√ßo - Dashboard</title>

<!-- Favicon da Marinha -->
<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<!-- CSS unificado -->
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { 
  getAuth, 
  signOut 
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  doc, 
  updateDoc, 
  onSnapshot 
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9GusKT_JuumqK_Bhf-X-ZtmUkzZK0lX0",
  authDomain: "vtr-marinha.firebaseapp.com",
  projectId: "vtr-marinha",
  storageBucket: "vtr-marinha.appspot.com",
  messagingSenderId: "503079573653",
  appId: "1:503079573653:web:beb34f57cd5447d376239c"
};

// Inicializa Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.logout = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

// =============================
// üîπ Atualiza√ß√£o em tempo real
// =============================
function carregarMissoes() {
  const tbody = document.getElementById("missoes-body");

  onSnapshot(collection(db, "viaturas_missao"), (snapshot) => {
    tbody.innerHTML = "";
    snapshot.forEach((docItem) => {
      const data = docItem.data();
      const tr = document.createElement("tr");

      // Destacar miss√£o fora da programa√ß√£o
      const destaque = data.fora_programacao 
        ? "style='background:rgba(255,0,0,0.06); border-left:4px solid #dc3545;'" 
        : "";

      tr.innerHTML = `
        <tr ${destaque}>
          <td>${data.missao || ""} 
            ${data.fora_programacao ? "<span style='color:#dc3545;font-weight:bold;'> ‚ö† Fora da Programa√ß√£o</span>" : ""}
          </td>
          <td>${data.motorista || ""}</td>
          <td>${data.viatura || ""}</td>
          <td>${data.status || ""}</td>
          <td>${data.odometro_inicio || ""}</td>
          <td>${data.horario_inicio || ""}</td>
          <td>${data.odometro_fim || ""}</td>
          <td>${data.horario_fim || ""}</td>
          <td>
            <button class="aprovar" onclick="aprovar('${docItem.id}')">Aprovar</button>
            <button class="negar" onclick="negar('${docItem.id}')">Negar</button>
          </td>
        </tr>
      `;
      tbody.appendChild(tr);
    });
  });
}
window.onload = carregarMissoes;

// =============================
// üîπ Criar miss√£o (com foraProg)
// =============================
window.criarMissao = async () => {
  const missao = document.getElementById("missao").value.trim();
  const motorista = document.getElementById("motorista").value.trim();
  const viatura = document.getElementById("viatura").value.trim();
  const foraProg = document.getElementById("foraProg").checked;

  if (!missao || !motorista || !viatura) {
    alert("‚ö†Ô∏è Preencha todos os campos antes de criar a miss√£o.");
    return;
  }

  try {
    await addDoc(collection(db, "viaturas_missao"), {
      missao,
      motorista,
      viatura,
      status: "Pendente",
      criado_por: auth.currentUser?.email || "ose",
      programada: !foraProg,
      fora_programacao: foraProg,
      criada_em: new Date().toLocaleString()
    });

    alert(foraProg ? "üö® Miss√£o fora da programa√ß√£o criada!" : "‚úÖ Miss√£o criada com sucesso!");
    document.querySelector(".form-missao").reset();
  } catch (erro) {
    console.error("Erro ao criar miss√£o:", erro);
    alert("‚ùå Erro ao criar miss√£o. Verifique a conex√£o e tente novamente.");
  }
};

// =============================
// üîπ Aprovar / Negar miss√£o
// =============================
window.aprovar = async (id) => {
  await updateDoc(doc(db, "viaturas_missao", id), { status: "Aprovada" });
};

window.negar = async (id) => {
  await updateDoc(doc(db, "viaturas_missao", id), { status: "Negada" });
};
</script>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo-marinha">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="Marinha do Brasil">
        <h1>Oficial de Servi√ßo</h1>
      </div>
      <button onclick="logout()">Sair</button>
    </header>

    <h2>Criar Nova Miss√£o</h2>
    <form onsubmit="event.preventDefault(); criarMissao();" class="form-missao">
      <input type="text" id="missao" placeholder="Descri√ß√£o da Miss√£o" required>
      <input type="text" id="motorista" placeholder="Motorista Respons√°vel" required>
      <input type="text" id="viatura" placeholder="Viatura (Ex: Parati E983-0987)" required>

      <div class="checkbox-linha">
        <label for="foraProg">
          <input type="checkbox" id="foraProg">
          <span>Miss√£o fora da programa√ß√£o</span>
        </label>
      </div>

      <button type="submit">Criar Miss√£o</button>
    </form>

    <h2>Miss√µes Pendentes</h2>
    <table>
      <thead>
        <tr>
          <th>Miss√£o</th>
          <th>Motorista</th>
          <th>Viatura</th>
          <th>Status</th>
          <th>Od√¥metro In√≠cio</th>
          <th>Hor√°rio In√≠cio</th>
          <th>Od√¥metro Fim</th>
          <th>Hor√°rio Fim</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="missoes-body"></tbody>
    </table>
  </div>
</body>
</html>
