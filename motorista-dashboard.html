<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Motorista - Dashboard</title>
<link rel="icon" type="image/svg+xml"
      href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
:root {
  --cor-primaria:#004aad;--cor-primaria-hover:#003b8e;
  --cor-fundo:#f5f7fa;--cor-texto:#1f2937;
  --cor-card:#fff;--cor-borda:#d1d5db;
  --cor-secundaria:#e2e8f0;
  --cor-sucesso:#16a34a;--cor-erro:#dc2626;--cor-aviso:#f59e0b;
}
@media(prefers-color-scheme:dark){
  :root{--cor-fundo:#0b1120;--cor-card:#111827;--cor-texto:#e5e7eb;
        --cor-borda:#1f2937;--cor-secundaria:#1e293b;}
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);
     min-height:100vh;padding:30px 10px;}
.container{max-width:1250px;margin:auto;background:var(--cor-card);
           border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.12);padding:28px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap}
header h1{color:var(--cor-primaria);font-size:1.5rem;margin:0;}
header button{background:var(--cor-erro);color:#fff;border:none;
              padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;}
header button:hover{background:#b91c1c;}
h2{color:var(--cor-primaria);margin:10px 0;border-left:4px solid var(--cor-primaria);padding-left:10px;}
.table-wrap{overflow:auto;border:1px solid var(--cor-borda);border-radius:10px;margin-top:10px}
table{width:100%;border-collapse:collapse;min-width:1000px}
thead{background:var(--cor-primaria);color:#fff}
th,td{padding:10px 12px;border-bottom:1px solid var(--cor-borda);text-align:left;vertical-align:top}
tbody tr:hover{background:rgba(0,74,173,.05)}
button{border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600}
button.inicio,button.fim{background:var(--cor-primaria);color:#fff}
button.inicio:hover,button.fim:hover{background:var(--cor-primaria-hover)}
.badge-ok{background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700}
.badge-no{background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700}
.small{font-size:.9rem;color:#475569}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Motorista ‚Äî Dashboard</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <h2>Minhas Miss√µes</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Miss√£o</th>
          <th>Viatura</th>
          <th>Status</th>
          <th>Od√¥metro In√≠cio</th>
          <th>Hor√°rio In√≠cio</th>
          <th>Od√¥metro Fim</th>
          <th>Hor√°rio Fim</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="missoes-body"></tbody>
    </table>
  </div>

  <p class="small" style="margin-top:10px">
    ‚Ä¢ Use <b>In√≠cio</b> ao sair com a viatura. ‚Ä¢ Use <b>Fim</b> ao retornar. <br/>
    ‚Ä¢ O sistema valida a sequ√™ncia do od√¥metro e atualiza o od√¥metro da viatura ao concluir.
  </p>
</div>

<script type="module">
import {auth, db} from "./firebase-config.js";
import {signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
  collection, doc, getDoc, updateDoc, onSnapshot, query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* ================= Prote√ß√£o (role) + Sess√£o (10 min) ================= */
const TIMEOUT = 10*60*1000; let t;
onAuthStateChanged(auth, async (u)=>{
  if(!u){ return window.location.href="index.html"; }
  const uDoc = await getDoc(doc(db,"usuarios",u.uid));
  if(!uDoc.exists() || (uDoc.data().role!=="motorista")){
    alert("Acesso restrito ao perfil: Motorista.");
    await signOut(auth);
    return window.location.href="index.html";
  }
  init(u);
  resetTimer();
  ["mousemove","keydown","click","scroll"].forEach(evt=>document.addEventListener(evt, resetTimer));
});
function resetTimer(){
  clearTimeout(t);
  t = setTimeout(async ()=>{
    alert("‚è∞ Sess√£o expirada por inatividade.");
    await signOut(auth);
    window.location.href="index.html";
  }, TIMEOUT);
}
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

/* ================= Estado / Init ================= */
let EU = null;
function init(user){
  EU = user;
  carregarMinhasMissoes();
}

/* =============== Minhas Miss√µes (somente as do motorista logado) =============== */
function carregarMinhasMissoes(){
  const qMinhas = query(collection(db, "viaturas_missao"), where("motorista","==", EU.email));
  onSnapshot(qMinhas, (snap)=>{
    const tb = document.getElementById("missoes-body");
    tb.innerHTML = "";
    snap.forEach(d=>{
      const m = {id:d.id, ...d.data()};

      // Bot√µes sempre dispon√≠veis conforme o progresso do od√¥metro
      const podeIniciar = !m.odometro_inicio;
      const podeFinalizar = !!m.odometro_inicio && !m.odometro_fim;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.missao||"-"}</td>
        <td>${m.viatura_label || m.viatura || "-"}</td>
        <td>${m.status || "Pendente"}</td>
        <td>${m.odometro_inicio ?? "-"}</td>
        <td>${m.horario_inicio ?? "-"}</td>
        <td>${m.odometro_fim ?? "-"}</td>
        <td>${m.horario_fim ?? "-"}</td>
        <td>
          ${podeIniciar ? `<button class="inicio" onclick="registrarInicio('${m.id}')">In√≠cio</button>` : ""}
          ${podeFinalizar ? `<button class="fim" onclick="registrarFim('${m.id}')">Fim</button>` : ""}
        </td>
      `;
      tb.appendChild(tr);
    });
  });
}

/* ================= Registrar In√≠cio ================= */
window.registrarInicio = async (missaoId)=>{
  const ref = doc(db,"viaturas_missao",missaoId);
  const dSnap = await getDoc(ref);
  if(!dSnap.exists()) return alert("Miss√£o n√£o encontrada.");
  const m = dSnap.data();
  if(m.odometro_inicio){ return alert("In√≠cio j√° registrado."); }
  const valor = prompt("Digite o od√¥metro inicial:");
  if(valor===null) return;
  const odo = Number(String(valor).replace(",","."));
  if(isNaN(odo) || odo < 0) return alert("Od√¥metro inv√°lido.");

  await updateDoc(ref, {
    odometro_inicio: odo,
    horario_inicio: new Date().toLocaleString(),
    motorista_inicio: auth.currentUser?.email || "",
    status: "Em viagem",
    atualizado_em: serverTimestamp()
  });
  alert("üìç In√≠cio registrado. Boa viagem!");
};

/* ================= Registrar Fim ================= */
window.registrarFim = async (missaoId)=>{
  const ref = doc(db,"viaturas_missao",missaoId);
  const dSnap = await getDoc(ref);
  if(!dSnap.exists()) return alert("Miss√£o n√£o encontrada.");
  const m = dSnap.data();
  if(!m.odometro_inicio) return alert("Registre o in√≠cio antes de finalizar.");
  if(m.odometro_fim) return alert("Fim j√° registrado.");

  const valor = prompt("Digite o od√¥metro final:");
  if(valor===null) return;
  const odo = Number(String(valor).replace(",","."));
  if(isNaN(odo) || odo < 0) return alert("Od√¥metro inv√°lido.");
  if(odo < Number(m.odometro_inicio)) return alert("Od√¥metro final n√£o pode ser menor que o inicial.");

  await updateDoc(ref, {
    odometro_fim: odo,
    horario_fim: new Date().toLocaleString(),
    motorista_fim: auth.currentUser?.email || "",
    status: "Conclu√≠da",
    atualizado_em: serverTimestamp()
  });

  if(m.viatura){
    try{
      await updateDoc(doc(db,"viaturas", m.viatura), { odometro: odo, atualizado_em: serverTimestamp() });
    }catch(e){
      console.warn("N√£o foi poss√≠vel atualizar od√¥metro da viatura:", e);
    }
  }

  alert("‚úÖ Fim registrado. Miss√£o conclu√≠da.");
};
</script>
</body>
</html>
