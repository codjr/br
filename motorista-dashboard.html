<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Motorista - Dashboard</title>

<link rel="icon" type="image/svg+xml"
 href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
/* ==========================================================
   UI FUTURISTA PREMIUM 2025 ‚Äî MOTORISTA
========================================================== */
:root {
  --cor-primaria: #004aad;
  --cor-primaria-hover: #003b8e;
  --cor-sucesso: #16a34a;
  --cor-erro: #dc2626;
  --cor-aviso: #f59e0b;
  --cor-fundo: #f5f7fa;
  --cor-card: #ffffff;
  --cor-borda: #d1d5db;
  --cor-texto: #1f2937;
}
@media (prefers-color-scheme: dark){
  :root {
    --cor-fundo:#0b1120; --cor-card:#111827; --cor-texto:#e5e7eb; --cor-borda:#1f2937;
  }
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);min-height:100vh}
header{
  background:var(--cor-primaria);color:#fff;display:flex;justify-content:space-between;align-items:center;
  padding:18px 25px;box-shadow:0 2px 10px rgba(0,0,0,.2)
}
header h1{font-size:1.25rem;margin:0}
header button{
  background:#dc2626;color:#fff;border:none;border-radius:6px;padding:8px 14px;cursor:pointer;font-weight:600;transition:.25s
}
header button:hover{background:#b91c1c}
.container{
  max-width:1150px;margin:30px auto;background:var(--cor-card);padding:24px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.1)
}
h2{color:var(--cor-primaria);margin:0 0 12px;border-left:4px solid var(--cor-primaria);padding-left:10px}
table{width:100%;border-collapse:collapse;margin-top:18px}
th,td{border-bottom:1px solid var(--cor-borda);padding:10px;text-align:left}
th{background:var(--cor-primaria);color:#fff}
tr:hover{background:rgba(0,74,173,.05)}

button{
  border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:600;transition:.25s
}
button.sucesso{background:var(--cor-sucesso);color:#fff}
button.sucesso:hover{background:#15803d}
button.info{background:var(--cor-primaria);color:#fff}
button.info:hover{background:var(--cor-primaria-hover)}
button.perigo{background:var(--cor-erro);color:#fff}
button.perigo:hover{background:#b91c1c}

.badge-ok{background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700;display:inline-block}
.badge-no{background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700;display:inline-block}
.tag-fp{color:var(--cor-aviso);font-weight:700}
.assins small{display:block;opacity:.85}
@media (max-width:820px){th,td{font-size:.95rem}}
</style>
</head>

<body>
<header>
  <h1>Motorista</h1>
  <button onclick="logout()">Sair</button>
</header>

<div class="container">
  <h2>Miss√µes de Viaturas</h2>
  <table>
    <thead>
      <tr>
        <th>Miss√£o</th>
        <th>Viatura</th>
        <th>Status</th>
        <th>Od√¥metro In√≠cio</th>
        <th>Hor√°rio In√≠cio</th>
        <th>Od√¥metro Fim</th>
        <th>Hor√°rio Fim</th>
        <th>Assinaturas</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="missoes-body"></tbody>
  </table>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* ==========================
   ‚öôÔ∏è Banner de Emula√ß√£o
========================== */
const params = new URLSearchParams(window.location.search);
const emulando = params.get("emulando");
if (emulando) {
  const aviso = document.createElement("div");
  aviso.style.position="fixed";aviso.style.top="0";aviso.style.left="0";aviso.style.right="0";
  aviso.style.zIndex="9999";aviso.style.padding="12px 20px";aviso.style.textAlign="center";
  aviso.style.fontWeight="600";aviso.style.color="#fff";
  aviso.style.background="linear-gradient(90deg,#004aad,#007bff)";
  aviso.style.boxShadow="0 3px 8px rgba(0,0,0,0.25)";
  aviso.innerHTML=`‚öôÔ∏è EMULANDO perfil de <b>${emulando}</b>
    <button id="sairEmulacao" style="margin-left:10px;background:#dc2626;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-weight:600;">Encerrar Emula√ß√£o</button>`;
  document.body.prepend(aviso);
  document.body.style.marginTop="60px";
  document.getElementById("sairEmulacao").onclick=()=>window.location.href="adm-dashboard.html";
}

/* ==========================
   üîê Logout
========================== */
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

/* ==========================
   üì° Monitorar miss√µes
========================== */
onSnapshot(collection(db,"viaturas_missao"),(snapshot)=>{
  const tbody=document.getElementById("missoes-body");
  tbody.innerHTML="";
  snapshot.forEach(docItem=>{
    const d=docItem.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.missao||"-"} ${d.fora_programacao?`<span class="tag-fp">‚ö† Fora da Programa√ß√£o</span>`:""}</td>
      <td>${d.viatura||"-"}</td>
      <td>${d.status||"-"}</td>
      <td>${d.odometro_inicio||"-"}</td>
      <td>${d.horario_inicio||"-"}</td>
      <td>${d.odometro_fim||"-"}</td>
      <td>${d.horario_fim||"-"}</td>
      <td class="assins">
        ${d.assinada_motorista?'<span class="badge-ok">Motorista</span>':'<span class="badge-no">Motorista</span>'}
        ${d.assinada_ose?'<span class="badge-ok">OSE</span>':'<span class="badge-no">OSE</span>'}
        ${d.assinada_encarregado?'<span class="badge-ok">Encarregado</span>':'<span class="badge-no">Encarregado</span>'}
        ${d.assinada_p3?'<span class="badge-ok">P3</span>':'<span class="badge-no">P3</span>'}
      </td>
      <td>
        <button class="info" onclick="registrarInicio('${docItem.id}')">In√≠cio</button>
        <button class="sucesso" onclick="registrarFim('${docItem.id}')">Fim</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
});

/* ==========================
   üöò Registrar in√≠cio
========================== */
window.registrarInicio = async(id)=>{
  const odometro = prompt("üìç Digite o od√¥metro inicial:");
  if(!odometro) return;
  const horario = new Date().toLocaleString();
  try{
    await updateDoc(doc(db,"viaturas_missao",id),{
      odometro_inicio:odometro,
      horario_inicio:horario,
      assinada_motorista:true,
      assinatura_motorista:auth.currentUser?.email||"motorista"
    });
    alert("‚úÖ In√≠cio registrado!");
  }catch(e){console.error(e);alert("Erro ao registrar in√≠cio.");}
};

/* ==========================
   üèÅ Registrar fim
========================== */
window.registrarFim = async(id)=>{
  const odometro = prompt("üìç Digite o od√¥metro final:");
  if(!odometro) return;
  const horario = new Date().toLocaleString();
  try{
    await updateDoc(doc(db,"viaturas_missao",id),{
      odometro_fim:odometro,
      horario_fim:horario,
      assinada_motorista:true,
      assinatura_motorista:auth.currentUser?.email||"motorista"
    });
    alert("üèÅ Fim da miss√£o registrado!");
  }catch(e){console.error(e);alert("Erro ao registrar fim.");}
};
</script>
</body>
</html>
