<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oficial de Servi√ßo - Dashboard</title>
<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
:root {
  --cor-primaria: #004aad;
  --cor-primaria-hover: #003b8e;
  --cor-fundo: #f5f7fa;
  --cor-texto: #1f2937;
  --cor-card: #ffffff;
  --cor-borda: #d1d5db;
  --cor-secundaria: #e2e8f0;
  --cor-sucesso: #16a34a;
  --cor-erro: #dc2626;
  --cor-aviso: #f59e0b;
}
@media (prefers-color-scheme: dark) {
  :root {
    --cor-fundo: #0b1120;
    --cor-card: #111827;
    --cor-texto: #e5e7eb;
    --cor-borda: #1f2937;
    --cor-secundaria: #1e293b;
  }
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);min-height:100vh;padding:30px 10px;}
.container{max-width:1200px;margin:auto;background:var(--cor-card);border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,0.12);padding:30px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
header h1{color:var(--cor-primaria);font-size:1.4rem;margin:0;}
header button{background:var(--cor-erro);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;}
header button:hover{background:#b91c1c;}
h2{color:var(--cor-primaria);margin-top:0;border-left:4px solid var(--cor-primaria);padding-left:10px;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
thead{background:var(--cor-primaria);color:white;}
th,td{padding:10px 12px;border-bottom:1px solid var(--cor-borda);text-align:left;}
tbody tr:hover{background:rgba(0,74,173,0.05);}
button{border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600;}
button.aprovar{background:var(--cor-sucesso);color:white;}
button.aprovar:hover{background:#15803d;}
button.negar{background:var(--cor-erro);color:white;}
button.negar:hover{background:#b91c1c;}
form input, form select{padding:8px;margin:5px;border:1px solid var(--cor-borda);border-radius:6px;}
form label{font-weight:600;}
.tag-fp{color:#dc2626;font-weight:700;}
.badge-ok{background:rgba(22,163,74,0.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700;}
.badge-no{background:rgba(220,38,38,0.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700;}
@media(max-width:768px){.container{padding:20px;}th,td{font-size:0.9rem;}}
</style>
</head>
<body>

<!-- Banner de Emula√ß√£o -->
<div id="emulacao-banner" style="
  display:none;background:#004aad;color:#fff;padding:10px 20px;text-align:center;
  font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
  üîß Modo Emula√ß√£o Ativo ‚Äî <span id="emulando-email"></span>
  <button onclick="window.location.href='adm-dashboard.html'" style="
    margin-left:10px;background:#fbbf24;color:#000;border:none;
    padding:6px 10px;border-radius:5px;cursor:pointer;font-weight:600;">Voltar ao ADM</button>
</div>

<div class="container">
  <header>
    <h1>Oficial de Servi√ßo - Dashboard</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <h2>Criar Nova Miss√£o</h2>
  <form onsubmit="event.preventDefault(); criarMissao();">
    <input type="text" id="missao" placeholder="Miss√£o" required>
    <input type="text" id="motorista" placeholder="Motorista" required>
    <input type="text" id="viatura" placeholder="Viatura" required>
    <label><input type="checkbox" id="foraProg"> Fora da Programa√ß√£o</label>
    <button type="submit" class="aprovar">Criar Miss√£o</button>
  </form>

  <h2>Miss√µes Pendentes e Criadas</h2>
  <table>
    <thead>
      <tr>
        <th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th>
        <th>Fora da Programa√ß√£o</th><th>Assinatura Encarregado</th><th>Assinatura P3</th><th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="missoes-body"></tbody>
  </table>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* =============== üîí Seguran√ßa e Logout Autom√°tico ================== */
const TEMPO_MAXIMO = 10 * 60 * 1000;
let timerLogout;
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    iniciarTimerLogout();
    monitorarAtividade();
  }
});
function iniciarTimerLogout() {
  clearTimeout(timerLogout);
  timerLogout = setTimeout(async () => {
    alert("‚è∞ Sess√£o expirada. Fa√ßa login novamente.");
    await signOut(auth);
    window.location.href = "index.html";
  }, TEMPO_MAXIMO);
}
function monitorarAtividade() {
  ["mousemove","keydown","click","scroll"].forEach(e => document.addEventListener(e, iniciarTimerLogout));
}

/* =============== üîß Banner de Emula√ß√£o ================== */
const params = new URLSearchParams(window.location.search);
const emulando = params.get("emulando");
if (emulando) {
  document.getElementById("emulacao-banner").style.display = "block";
  document.getElementById("emulando-email").innerText = emulando;
}

/* =============== üö™ Logout ================== */
window.logout = async()=>{await signOut(auth);window.location.href="index.html";}

/* =============== ‚öôÔ∏è Carregar Miss√µes em Tempo Real ================== */
onSnapshot(collection(db,"viaturas_missao"),(snapshot)=>{
  const tbody=document.getElementById("missoes-body");
  tbody.innerHTML="";
  snapshot.forEach(docItem=>{
    const m=docItem.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m.missao||""}</td>
      <td>${m.motorista||""}</td>
      <td>${m.viatura||""}</td>
      <td>${m.status||"Pendente"}</td>
      <td>${m.fora_programacao ? "<span class='tag-fp'>‚ö† Fora</span>" : "-"}</td>
      <td>${
        m.assinatura_encarregado
        ? `<span class='badge-ok'>${m.assinatura_encarregado}</span><br><small>${m.hora_assinatura_encarregado||""}</small>`
        : "<span class='badge-no'>Pendente</span>"
      }</td>
      <td>${
        m.assinatura_p3
        ? `<span class='badge-ok'>${m.assinatura_p3}</span><br><small>${m.hora_assinatura_p3||""}</small>`
        : "<span class='badge-no'>Pendente</span>"
      }</td>
      <td>
        <button class='aprovar' onclick="aprovar('${docItem.id}')">Aprovar</button>
        <button class='negar' onclick="negar('${docItem.id}')">Negar</button>
      </td>`;
    tbody.appendChild(tr);
  });
});

/* =============== ‚úÖ Aprovar / Negar Miss√£o ================== */
window.aprovar = async(id)=>{
  await updateDoc(doc(db,"viaturas_missao",id),{
    status:"Aprovada",
    assinada_ose:true,
    assinatura_ose:auth.currentUser?.email || "OSE",
    hora_assinatura_ose:new Date().toLocaleString(),
    atualizado_em:serverTimestamp()
  });
  alert("‚úÖ Miss√£o aprovada e assinada pela OSE.");
};
window.negar = async(id)=>{
  await updateDoc(doc(db,"viaturas_missao",id),{
    status:"Negada",
    assinatura_ose:auth.currentUser?.email || "OSE",
    hora_assinatura_ose:new Date().toLocaleString(),
    atualizado_em:serverTimestamp()
  });
  alert("‚ùå Miss√£o negada.");
};

/* =============== üÜï Criar Miss√£o ================== */
window.criarMissao = async()=>{
  const missao=document.getElementById("missao").value.trim();
  const motorista=document.getElementById("motorista").value.trim();
  const viatura=document.getElementById("viatura").value.trim();
  const foraProg=document.getElementById("foraProg").checked;
  if(!missao||!motorista||!viatura){alert("Preencha todos os campos.");return;}
  await addDoc(collection(db,"viaturas_missao"),{
    missao,motorista,viatura,
    fora_programacao:foraProg,
    status:"Pendente",
    criada_por:auth.currentUser?.email || "OSE",
    criada_em:serverTimestamp()
  });
  document.getElementById("missao").value="";
  document.getElementById("motorista").value="";
  document.getElementById("viatura").value="";
  document.getElementById("foraProg").checked=false;
  alert("üÜï Miss√£o criada com sucesso!");
};
</script>
</body>
</html>
