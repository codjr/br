<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administrador - Dashboard</title>
<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
:root {
  --cor-primaria: #004aad;
  --cor-primaria-hover: #003b8e;
  --cor-fundo: #f5f7fa;
  --cor-texto: #1f2937;
  --cor-card: #ffffff;
  --cor-borda: #d1d5db;
  --cor-secundaria: #e2e8f0;
  --cor-sucesso: #16a34a;
  --cor-erro: #dc2626;
  --cor-aviso: #f59e0b;
  --cor-info: #2563eb;
  --sombra: rgba(0, 0, 0, 0.1);
}

@media (prefers-color-scheme: dark) {
  :root {
    --cor-fundo: #0b1120;
    --cor-card: #111827;
    --cor-texto: #e5e7eb;
    --cor-borda: #1f2937;
    --cor-secundaria: #1e293b;
    --sombra: rgba(255, 255, 255, 0.05);
  }
}

* {
  box-sizing: border-box;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  margin: 0;
  padding: 0;
}

body {
  background: var(--cor-fundo);
  color: var(--cor-texto);
  min-height: 100vh;
  padding: 30px 10px;
}

/* ===== CONTAINER ===== */
.container {
  max-width: 1250px;
  margin: auto;
  background: var(--cor-card);
  border-radius: 10px;
  box-shadow: 0 4px 18px var(--sombra);
  padding: 24px;
  transition: 0.3s;
}

.container:hover {
  box-shadow: 0 6px 24px var(--sombra);
}

/* ===== CABEÇALHO ===== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 10px;
}

.logo-marinha {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-marinha img {
  width: 52px;
  height: 52px;
}

header h1 {
  color: var(--cor-primaria);
  font-size: 1.4rem;
  margin: 0;
  font-weight: 700;
}

header button {
  background: var(--cor-erro);
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.25s;
}

header button:hover {
  background: #b91c1c;
}

/* ===== TABS ===== */
.nav-tabs {
  display: flex;
  gap: 8px;
  margin: 12px 0 18px;
  flex-wrap: wrap;
}

.nav-tabs button {
  background: var(--cor-secundaria);
  border: 1px solid var(--cor-borda);
  color: var(--cor-texto);
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.nav-tabs button:hover {
  filter: brightness(0.95);
}

.nav-tabs button.active {
  background: var(--cor-primaria);
  color: #fff;
  border-color: var(--cor-primaria);
}

/* ===== TÍTULOS ===== */
h2 {
  color: var(--cor-primaria);
  margin: 0 0 8px;
  border-left: 4px solid var(--cor-primaria);
  padding-left: 10px;
  font-weight: 700;
}

/* ===== TABELAS ===== */
.table-wrap {
  overflow-x: auto;
  border: 1px solid var(--cor-borda);
  border-radius: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

thead {
  background: var(--cor-primaria);
  color: #fff;
}

th, td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--cor-borda);
  text-align: left;
  vertical-align: middle;
}

tbody tr:hover {
  background: rgba(0, 74, 173, 0.05);
  transition: background 0.2s;
}

/* ===== BOTÕES ===== */
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

button.aprovar {
  background: var(--cor-sucesso);
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  transition: 0.2s;
}
button.aprovar:hover { background: #15803d; }

button.desaprovar {
  background: var(--cor-info);
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  transition: 0.2s;
}
button.desaprovar:hover { background: #1d4ed8; }

button.editar {
  background: var(--cor-aviso);
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  transition: 0.2s;
}
button.editar:hover { background: #b45309; }

button.reset {
  background: var(--cor-secundaria);
  color: var(--cor-texto);
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  transition: 0.2s;
}
button.reset:hover { filter: brightness(0.9); }

button.excluir {
  background: var(--cor-erro);
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  transition: 0.2s;
}
button.excluir:hover { background: #b91c1c; }

/* ===== BADGES ===== */
.badge-ok {
  background: rgba(22,163,74,0.12);
  color: #166534;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 700;
}
.badge-no {
  background: rgba(220,38,38,0.12);
  color: #991b1b;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 700;
}
.badge-warn {
  background: rgba(245,158,11,0.12);
  color: #92400e;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 700;
}
.tag-fp {
  color: var(--cor-erro);
  font-weight: 700;
}

/* ===== FILTROS ===== */
.filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  margin: 8px 0 12px;
}
.filters input,
.filters select {
  padding: 8px 10px;
  border: 1px solid var(--cor-borda);
  border-radius: 8px;
  background: #fff;
  font-size: 14px;
  transition: 0.2s;
}
.filters input:focus,
.filters select:focus {
  outline: none;
  border-color: var(--cor-primaria);
  box-shadow: 0 0 0 2px rgba(0, 74, 173, 0.2);
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 900px) {
  header { flex-direction: column; align-items: flex-start; }
  .logo-marinha img { width: 42px; height: 42px; }
  table { min-width: 700px; }
}
@media (max-width: 600px) {
  body { padding: 15px 6px; }
  .container { padding: 14px; }
  header h1 { font-size: 1rem; text-align: center; }
  .nav-tabs { flex-wrap: wrap; justify-content: center; }
  .nav-tabs button { flex: 1 1 auto; font-size: 0.9rem; }
  table { min-width: 580px; }
  .actions button { flex: 1 1 45%; font-size: 0.85rem; }
}
</style>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo-marinha">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="Marinha do Brasil">
        <h1>Administrador — Sistema de Viaturas</h1>
      </div>
      <button onclick="logout()">Sair</button>
    </header>

    <div class="nav-tabs">
      <button class="active" data-tab="tab-usuarios" onclick="setTab('tab-usuarios', this)">Usuários</button>
      <button data-tab="tab-missoes" onclick="setTab('tab-missoes', this)">Missões</button>
      <button data-tab="tab-logs" onclick="setTab('tab-logs', this)">Logs do Sistema</button>
      <button data-tab="tab-emulacao" onclick="setTab('tab-emulacao', this)">Emulação</button>
    </div>

    <!-- Usuários -->
    <section id="tab-usuarios" class="tab-pane" style="display:block;">
      <h2>Gerenciamento de Usuários</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Status</th><th style="min-width:420px">Ações</th></tr>
          </thead>
          <tbody id="usuarios-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Missões -->
    <section id="tab-missoes" class="tab-pane" style="display:none;">
      <h2>Missões (todas)</h2>
      <div class="filters">
        <select id="filtro-status" onchange="filtrarMissoes()">
          <option value="">Status: Todos</option>
          <option value="Pendente">Pendente</option>
          <option value="Aprovada pela OSE">Aprovada pela OSE</option>
          <option value="Negada pela OSE">Negada pela OSE</option>
          <option value="Em viagem">Em viagem</option>
          <option value="Concluída">Concluída</option>
        </select>
        <input id="busca-missao" type="search" placeholder="Buscar missão/viatura/motorista..." oninput="filtrarMissoes()"/>
        <span class="badge-warn">⚠ Fora da Programação aparece destacado</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Missão</th><th>Motorista</th><th>Viatura</th><th>Status</th>
              <th>Odômetro Início</th><th>Horário Início</th>
              <th>Odômetro Fim</th><th>Horário Fim</th>
              <th>Assinaturas</th>
              <th style="min-width:220px">Ações</th>
            </tr>
          </thead>
          <tbody id="missoes-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Logs -->
    <section id="tab-logs" class="tab-pane" style="display:none;">
      <h2>Logs do Sistema</h2>
      <div class="filters">
        <input id="busca-logs" type="search" placeholder="Buscar por ação, alvo, e-mail..." oninput="filtrarLogs()"/>
        <button class="reset" onclick="exportarLogs()">Exportar CSV</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Ação</th><th>Alvo</th><th>Feito por</th><th>Data/Hora</th></tr></thead>
          <tbody id="logs-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Emulação -->
    <section id="tab-emulacao" class="tab-pane" style="display:none;">
      <h2>Emulação de Perfil</h2>
      <div class="filters">
        <input id="busca-emulacao" type="search" placeholder="Buscar usuário por nome/email..." oninput="filtrarEmulacao()"/>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Ação</th></tr></thead>
          <tbody id="emulacao-body"></tbody>
        </table>
      </div>
      <p class="badge-warn" style="margin-top:8px;">⚙ Você será redirecionado ao dashboard do cargo com <b>?emulando=email</b>.</p>
    </section>
  </div>

<script type="module">
/* === Firebase Imports === */
import { auth, db } from "./firebase-config.js";
import { signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* Sessão e Logout */
const LIMITE = 10*60*1000; let t;
onAuthStateChanged(auth, async (u)=>{
  if(!u){ return window.location.href="index.html"; }
  const uDoc = await getDoc(doc(db,"usuarios", u.uid));
  if(!uDoc.exists() || uDoc.data().role!=="adm"){
    alert("Acesso permitido apenas ao Administrador.");
    await signOut(auth); return window.location.href="index.html";
  }
  init();
  reset();
  ["mousemove","keydown","click","scroll"].forEach(e=>document.addEventListener(e, reset));
});
function reset(){ clearTimeout(t); t=setTimeout(async()=>{ alert("⏰ Sessão expirada."); await signOut(auth); window.location.href="index.html"; }, LIMITE); }
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

/* Tabs */
window.setTab = (id, btn)=>{
  document.querySelectorAll(".tab-pane").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".nav-tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
};

/* Log helper */
async function logAction(acao, alvo, extra={}) {
  try {
    await addDoc(collection(db,"logs"), {
      acao, alvo,
      feito_por_uid: auth.currentUser?.uid || null,
      feito_por_email: auth.currentUser?.email || null,
      data_hora: serverTimestamp(), ...extra
    });
  } catch(e){ console.warn("Falha ao gravar log:", e); }
}

/* Inicialização */
function init(){ carregarUsuarios(); carregarMissoesRealtime(); carregarLogsRealtime(); carregarEmulacaoRealtime(); }

/* Usuários */
function carregarUsuarios(){
  const tbody = document.getElementById("usuarios-body");
  onSnapshot(collection(db,"usuarios"), (snap)=>{
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const u = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nome||"-"}</td>
        <td>${u.email||"-"}</td>
        <td>${u.role||"-"}</td>
        <td>${u.aprovado?'<span class="badge-ok">Aprovado</span>':'<span class="badge-no">Pendente</span>'}</td>
        <td class="actions">
          <button class="aprovar" onclick="aprovar('${d.id}')">✔ Aprovar</button>
          <button class="desaprovar" onclick="desaprovar('${d.id}')">✖ Desaprovar</button>
          <button class="editar" onclick="editarUsuario('${d.id}','${(u.nome||'').replace(/"/g,'&quot;')}','${u.role||''}')">✏ Editar</button>
          <button class="reset" onclick="resetSenha('${u.email||''}')">🔁 Resetar Senha</button>
          <button class="excluir" onclick="excluirUsuario('${d.id}')">🗑 Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}
window.aprovar = async(uid)=>{ await updateDoc(doc(db,"usuarios",uid), {aprovado:true}); await logAction("Aprovar usuário", uid); alert("Usuário aprovado!"); };
window.desaprovar = async(uid)=>{ await updateDoc(doc(db,"usuarios",uid), {aprovado:false}); await logAction("Desaprovar usuário", uid); alert("Usuário desaprovado!"); };
window.editarUsuario = async(uid,nomeAtual,cargoAtual)=>{ const novoNome=prompt("Novo nome:",nomeAtual)||""; const novoCargo=prompt("Novo cargo:",cargoAtual)||""; if(!novoNome||!novoCargo)return alert("Cancelado"); await updateDoc(doc(db,"usuarios",uid),{nome:novoNome,role:novoCargo}); await logAction("Editar usuário",uid,{nome:novoNome,role:novoCargo}); alert("Usuário atualizado."); };
window.resetSenha = async(email)=>{ if(!email)return alert("Usuário sem email"); try{ await sendPasswordResetEmail(auth,email); alert(`Email de redefinição enviado para ${email}`); await logAction("Reset senha",email); }catch(e){ alert("Erro ao enviar redefinição"); } };
window.excluirUsuario = async(uid)=>{ if(!confirm("Excluir usuário?"))return; await deleteDoc(doc(db,"usuarios",uid)); await logAction("Excluir usuário",uid); alert("Usuário excluído."); };

/* Missões */
let MISSOES_CACHE=[];
function carregarMissoesRealtime(){
  onSnapshot(collection(db,"viaturas_missao"),(snap)=>{
    MISSOES_CACHE=[]; snap.forEach(d=>MISSOES_CACHE.push({id:d.id,...d.data()}));
    renderMissoes(MISSOES_CACHE);
  });
}
function renderMissoes(list){
  const tbody=document.getElementById("missoes-body");
  tbody.innerHTML="";
  list.forEach(m=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m.missao||"-"} ${m.fora_programacao?'<span class="tag-fp">⚠ Fora</span>':""}</td>
      <td>${m.motorista||"-"}</td>
      <td>${m.viatura_label||m.viatura||"-"}</td>
      <td>${m.status||"Pendente"}</td>
      <td>${m.odometro_inicio||"-"}</td>
      <td>${m.horario_inicio||"-"}</td>
      <td>${m.odometro_fim||"-"}</td>
      <td>${m.horario_fim||"-"}</td>
      <td>
        ${(m.assinatura_ose||"-")}<br>
        ${(m.assinatura_encarregado||"-")}<br>
        ${(m.assinatura_chedep||"-")}
      </td>
      <td class="actions">
        <button class="editar" onclick="editarMissao('${m.id}')">✏ Editar</button>
        <button class="reset" onclick="alterarStatus('${m.id}')">↺ Status</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
window.filtrarMissoes=()=>{ const st=document.getElementById("filtro-status").value; const q=(document.getElementById("busca-missao").value||"").toLowerCase(); renderMissoes(MISSOES_CACHE.filter(m=>{ const okSt=st?m.status===st:true; const okQ=q?(`${m.missao||""} ${m.motorista||""} ${m.viatura_label||""}`).toLowerCase().includes(q):true; return okSt&&okQ; })); };
window.editarMissao=async(id)=>{ const ref=doc(db,"viaturas_missao",id); const d=await getDoc(ref); if(!d.exists())return; const m=d.data(); const missao=prompt("Missão:",m.missao||""); if(missao===null)return; const motorista=prompt("Motorista:",m.motorista||""); const viatura_label=prompt("Viatura:",m.viatura_label||""); await updateDoc(ref,{missao,motorista,viatura_label}); await logAction("Editar missão",id); alert("Missão atualizada."); };
window.alterarStatus=async(id)=>{ const status=prompt("Novo status:",""); if(!status)return; await updateDoc(doc(db,"viaturas_missao",id),{status}); await logAction("Alterar status missão",id,{status}); alert("Status atualizado."); };

/* Logs */
let LOGS_CACHE=[];
function carregarLogsRealtime(){
  onSnapshot(query(collection(db,"logs"),orderBy("data_hora","desc")),(snap)=>{
    LOGS_CACHE=[]; const tbody=document.getElementById("logs-body"); tbody.innerHTML="";
    snap.forEach(d=>{ const l=d.data(); const row={acao:l.acao||"",alvo:l.alvo||"",feito_por:l.feito_por_email||"",data_hora:l.data_hora?.toDate?l.data_hora.toDate().toLocaleString():""}; LOGS_CACHE.push(row); const tr=document.createElement("tr"); tr.innerHTML=`<td>${row.acao}</td><td>${row.alvo}</td><td>${row.feito_por}</td><td>${row.data_hora}</td>`; tbody.appendChild(tr); });
    filtrarLogs();
  });
}
window.filtrarLogs=()=>{ const termo=(document.getElementById("busca-logs").value||"").toLowerCase(); Array.from(document.querySelectorAll("#logs-body tr")).forEach(tr=>{ tr.style.display=tr.innerText.toLowerCase().includes(termo)?"":"none"; }); };
window.exportarLogs=()=>{ if(!LOGS_CACHE.length)return alert("Sem dados."); const head=Object.keys(LOGS_CACHE[0]).join(";"); const body=LOGS_CACHE.map(r=>Object.values(r).map(v=>`"${(v??"").toString().replace(/"/g,'""')}"`).join(";")).join("\n"); const blob=new Blob([head+"\n"+body],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`logs_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url); };

/* Emulação */
function carregarEmulacaoRealtime(){
  const tbody=document.getElementById("emulacao-body");
  onSnapshot(collection(db,"usuarios"),(snap)=>{
    tbody.innerHTML=""; snap.forEach(d=>{ const u=d.data(); const tr=document.createElement("tr"); tr.innerHTML=`<td>${u.nome||"-"}</td><td>${u.email||"-"}</td><td>${u.role||"-"}</td><td><button class="editar" onclick="emularPerfil('${u.email||''}','${u.role||''}')">Emular</button></td>`; tbody.appendChild(tr); });
  });
}
window.emularPerfil=(email,role)=>{ if(!email||!role)return alert("Usuário inválido"); const destino=({adm:"adm-dashboard.html",chefe:"chefe-dashboard.html",ose:"ose-dashboard.html",encarregado:"encarregado-dashboard.html",motorista:"motorista-dashboard.html",aux_encarregado:"aux-encarregado-dashboard.html"}[role]||"index.html"); window.location.href=`${destino}?emulando=${encodeURIComponent(email)}`; };
</script>
</body>
</html>
