<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administrador - Dashboard</title>
<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
:root{
  --cor-primaria:#004aad;
  --cor-primaria-900:#003b8e;
  --cor-fundo:#f5f7fa;
  --cor-texto:#1f2937;
  --cor-card:#ffffff;
  --cor-borda:#d1d5db;
  --cor-secundaria:#eef2f7;
  --cor-secundaria-600:#e2e8f0;
  --cor-sucesso:#16a34a;
  --cor-erro:#dc2626;
  --cor-aviso:#f59e0b;
  --cor-info:#2563eb;
  --sombra:0 6px 24px rgba(0,0,0,.08);
  --sombra-2:0 10px 30px rgba(0,0,0,.12);
  --sidebar-w:260px;
  --radius:12px;
  --radius-sm:8px;
}

@media (prefers-color-scheme: dark){
  :root{
    --cor-fundo:#0b1120;
    --cor-card:#111827;
    --cor-texto:#e5e7eb;
    --cor-borda:#1f2937;
    --cor-secundaria:#0f172a;
    --cor-secundaria-600:#1e293b;
    --sombra:0 6px 24px rgba(255,255,255,.06);
    --sombra-2:0 10px 30px rgba(255,255,255,.08);
  }
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Segoe UI", Roboto, Arial, sans-serif;
  background:var(--cor-fundo);
  color:var(--cor-texto);
}

/* ===== TOPBAR ===== */
.topbar{
  position:sticky; top:0; z-index:60;
  background:var(--cor-card);
  box-shadow:var(--sombra);
  padding:10px 14px;
  display:flex; align-items:center; gap:12px; justify-content:space-between;
}
.topbar-left{display:flex; align-items:center; gap:10px}
.btn-burger{
  border:none; background:var(--cor-primaria); color:#fff; width:40px; height:40px;
  border-radius:10px; cursor:pointer; font-size:1.2rem; display:inline-flex; align-items:center; justify-content:center;
  transition:.2s;
}
.btn-burger:hover{background:var(--cor-primaria-900)}
.brand{
  display:flex; align-items:center; gap:10px;
}
.brand img{width:34px; height:34px}
.brand h1{font-size:1.05rem; margin:0; color:var(--cor-primaria); font-weight:800}
.topbar .btn-logout{
  background:var(--cor-erro); color:#fff; border:none; padding:8px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.2s;
}
.topbar .btn-logout:hover{filter:brightness(.9)}

/* ===== LAYOUT GRID ===== */
.layout{
  display:grid;
  grid-template-columns: var(--sidebar-w) 1fr;
  gap:16px;
  padding:16px;
}
@media (max-width: 980px){
  .layout{grid-template-columns: 1fr}
}

/* ===== SIDEBAR (off-canvas no mobile) ===== */
.sidebar{
  background:var(--cor-card);
  border:1px solid var(--cor-borda);
  border-radius:var(--radius);
  box-shadow:var(--sombra);
  padding:14px;
  height:calc(100vh - 100px);
  position:sticky; top:82px; /* abaixo da topbar */
  overflow:auto;
}
.sidebar .title{
  font-size:.9rem; font-weight:800; color:var(--cor-primaria);
  margin-bottom:8px; letter-spacing:.02em;
}
.navlist{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px}
.navlist button{
  width:100%; text-align:left; border:none; cursor:pointer;
  background:var(--cor-secundaria);
  color:var(--cor-texto);
  border:1px solid var(--cor-borda);
  padding:10px 12px; border-radius:10px; font-weight:700; transition:.15s;
}
.navlist button:hover{filter:brightness(.97)}
.navlist button.active{background:var(--cor-primaria); color:#fff; border-color:var(--cor-primaria)}
.sidebar .hr{height:1px; background:var(--cor-borda); margin:12px 0}

/* Off-canvas behavior */
@media (max-width: 980px){
  .sidebar{
    position:fixed; inset:0 auto 0 0; width:var(--sidebar-w);
    transform:translateX(-110%); transition:transform .25s ease;
    height:100dvh; top:0; border-radius:0; z-index:80;
  }
  .sidebar.open{ transform:translateX(0) }
  .sidebar .title{margin-top:8px}
  .overlay{
    content:""; position:fixed; inset:0; background:rgba(0,0,0,.35);
    backdrop-filter:saturate(110%) blur(2px);
    opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:70;
  }
  .overlay.show{opacity:1; pointer-events:auto}
}

/* ===== CONTENT CARD ===== */
.content{
  background:var(--cor-card);
  border:1px solid var(--cor-borda);
  border-radius:var(--radius);
  box-shadow:var(--sombra-2);
  padding:18px;
  min-height:calc(100vh - 130px);
}

/* Abas superiores (mantidas no desktop; escondidas no mobile p/ evitar duplicidade) */
.nav-tabs{
  display:flex; gap:8px; margin:4px 0 16px; flex-wrap:wrap;
}
.nav-tabs button{
  background:var(--cor-secundaria-600);
  border:1px solid var(--cor-borda);
  color:var(--cor-texto);
  padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; transition:.15s;
}
.nav-tabs button.active{ background:var(--cor-primaria); color:#fff; border-color:var(--cor-primaria) }
@media (max-width: 980px){ .nav-tabs{ display:none } }

/* ===== TITULOS ===== */
h2{
  color:var(--cor-primaria);
  margin:0 0 10px;
  border-left:4px solid var(--cor-primaria);
  padding-left:10px; font-weight:800;
}

/* ===== TABELAS ===== */
.table-wrap{
  overflow:auto;
  border:1px solid var(--cor-borda);
  border-radius:12px;
}
table{
  width:100%; border-collapse:collapse; min-width:880px;
}
thead{ background:var(--cor-primaria); color:#fff }
th,td{ padding:10px 12px; border-bottom:1px solid var(--cor-borda); text-align:left; vertical-align:middle }
tbody tr:hover{ background:rgba(0,74,173,.06); transition:background .15s }

/* ===== FILTROS ===== */
.filters{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0 12px }
.filters input,.filters select{
  padding:8px 10px; border:1px solid var(--cor-borda); border-radius:10px; background:#fff; font-size:14px; transition:.15s;
}
.filters input:focus,.filters select:focus{ outline:none; border-color:var(--cor-primaria); box-shadow:0 0 0 2px rgba(0,74,173,.18) }

/* ===== BADGES ===== */
.badge-ok{ display:inline-block; background:rgba(22,163,74,.12); color:#166534; padding:4px 8px; border-radius:8px; font-weight:800 }
.badge-no{ display:inline-block; background:rgba(220,38,38,.12); color:#991b1b; padding:4px 8px; border-radius:8px; font-weight:800 }
.badge-warn{ display:inline-block; background:rgba(245,158,11,.12); color:#92400e; padding:4px 8px; border-radius:8px; font-weight:800 }
.tag-fp{ color:var(--cor-erro); font-weight:800 }

/* ===== BOTOES DE ACAO ===== */
.actions{ display:flex; flex-wrap:wrap; gap:6px }
button.aprovar{ background:var(--cor-sucesso); color:#fff; border:none; padding:7px 10px; border-radius:10px; font-weight:800; cursor:pointer; transition:.15s }
button.aprovar:hover{ filter:brightness(.95) }
button.desaprovar{ background:var(--cor-info); color:#fff; border:none; padding:7px 10px; border-radius:10px; font-weight:800; cursor:pointer; transition:.15s }
button.desaprovar:hover{ filter:brightness(.95) }
button.editar{ background:var(--cor-aviso); color:#fff; border:none; padding:7px 10px; border-radius:10px; font-weight:800; cursor:pointer; transition:.15s }
button.editar:hover{ filter:brightness(.95) }
button.reset{ background:var(--cor-secundaria-600); color:var(--cor-texto); border:none; padding:7px 10px; border-radius:10px; font-weight:800; cursor:pointer; transition:.15s }
button.reset:hover{ filter:brightness(.95) }
button.excluir{ background:var(--cor-erro); color:#fff; border:none; padding:7px 10px; border-radius:10px; font-weight:800; cursor:pointer; transition:.15s }
button.excluir:hover{ filter:brightness(.95) }

/* ===== RESPONSIVIDADE EXTRA ===== */
@media (max-width: 680px){
  .brand h1{ font-size:.95rem }
  table{ min-width:620px }
  .actions button{ flex:1 1 46% }
}
@media (max-width: 420px){
  .btn-burger{ width:36px; height:36px; font-size:1.05rem }
  .topbar .btn-logout{ padding:7px 12px }
}
</style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar" role="banner">
    <div class="topbar-left">
      <button class="btn-burger" id="btnBurger" aria-label="Abrir menu" aria-expanded="false">‚ò∞</button>
      <div class="brand">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="">
        <h1>Administrador ‚Äî Sistema de Viaturas</h1>
      </div>
    </div>
    <button class="btn-logout" onclick="logout()">Sair</button>
  </div>

  <!-- Layout -->
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Menu lateral" aria-hidden="true">
      <div class="title">Navega√ß√£o</div>
      <ul class="navlist">
        <li><button class="active" data-target="tab-usuarios">üë• Usu√°rios</button></li>
        <li><button data-target="tab-missoes">üß≠ Miss√µes</button></li>
        <li><button data-target="tab-logs">üìú Logs do Sistema</button></li>
        <li><button data-target="tab-emulacao">üß™ Emula√ß√£o</button></li>
      </ul>
      <div class="hr"></div>
      <small style="opacity:.8">Use <b>Esc</b> para fechar o menu.</small>
    </aside>
    <div class="overlay" id="overlay"></div>

    <!-- Content -->
    <main class="content">
      <!-- Tabs (vis√≠veis s√≥ no desktop) -->
      <div class="nav-tabs" aria-label="Abas">
        <button class="active" data-tab="tab-usuarios" onclick="setTab('tab-usuarios', this)">Usu√°rios</button>
        <button data-tab="tab-missoes" onclick="setTab('tab-missoes', this)">Miss√µes</button>
        <button data-tab="tab-logs" onclick="setTab('tab-logs', this)">Logs do Sistema</button>
        <button data-tab="tab-emulacao" onclick="setTab('tab-emulacao', this)">Emula√ß√£o</button>
      </div>

      <!-- Usu√°rios -->
      <section id="tab-usuarios" class="tab-pane" style="display:block;">
        <h2>Gerenciamento de Usu√°rios</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Status</th><th style="min-width:460px">A√ß√µes</th></tr>
            </thead>
            <tbody id="usuarios-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Miss√µes -->
      <section id="tab-missoes" class="tab-pane" style="display:none;">
        <h2>Miss√µes (todas)</h2>
        <div class="filters">
          <select id="filtro-status" onchange="filtrarMissoes()">
            <option value="">Status: Todos</option>
            <option value="Pendente">Pendente</option>
            <option value="Aprovada pela OSE">Aprovada pela OSE</option>
            <option value="Negada pela OSE">Negada pela OSE</option>
            <option value="Em viagem">Em viagem</option>
            <option value="Conclu√≠da">Conclu√≠da</option>
          </select>
          <input id="busca-missao" type="search" placeholder="Buscar miss√£o/viatura/motorista..." oninput="filtrarMissoes()"/>
          <span class="badge-warn">‚ö† Fora da Programa√ß√£o aparece destacado</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th>
                <th>Od√¥metro In√≠cio</th><th>Hor√°rio In√≠cio</th>
                <th>Od√¥metro Fim</th><th>Hor√°rio Fim</th>
                <th>Assinaturas</th>
                <th style="min-width:220px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="missoes-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Logs -->
      <section id="tab-logs" class="tab-pane" style="display:none;">
        <h2>Logs do Sistema</h2>
        <div class="filters">
          <input id="busca-logs" type="search" placeholder="Buscar por a√ß√£o, alvo, e-mail..." oninput="filtrarLogs()"/>
          <button class="reset" onclick="exportarLogs()">Exportar CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>A√ß√£o</th><th>Alvo</th><th>Feito por</th><th>Data/Hora</th></tr></thead>
            <tbody id="logs-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Emula√ß√£o -->
      <section id="tab-emulacao" class="tab-pane" style="display:none;">
        <h2>Emula√ß√£o de Perfil</h2>
        <div class="filters">
          <input id="busca-emulacao" type="search" placeholder="Buscar usu√°rio por nome/email..." oninput="filtrarEmulacao()"/>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th><th>A√ß√£o</th></tr></thead>
            <tbody id="emulacao-body"></tbody>
          </table>
        </div>
        <p class="badge-warn" style="margin-top:8px;">‚öô Voc√™ ser√° redirecionado ao dashboard do cargo com <b>?emulando=email</b>.</p>
      </section>
    </main>
  </div>

<script type="module">
/* ===== Firebase ===== */
import { auth, db } from "./firebase-config.js";
import { signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
  collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* ===== Sess√£o e Acesso ===== */
const LIMITE = 10*60*1000; let t;
onAuthStateChanged(auth, async (u)=>{
  if(!u){ return window.location.href="index.html"; }
  const uDoc = await getDoc(doc(db,"usuarios", u.uid));
  if(!uDoc.exists() || uDoc.data().role!=="adm"){
    alert("Acesso permitido apenas ao Administrador.");
    await signOut(auth); return window.location.href="index.html";
  }
  init();
  reset();
  ["mousemove","keydown","click","scroll","touchstart"].forEach(e=>document.addEventListener(e, reset));
});
function reset(){ clearTimeout(t); t=setTimeout(async()=>{ alert("‚è∞ Sess√£o expirada."); await signOut(auth); window.location.href="index.html"; }, LIMITE); }
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

/* ===== Sidebar (off-canvas) ===== */
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const btnBurger = document.getElementById('btnBurger');

function openSidebar(){
  sidebar.classList.add('open');
  overlay.classList.add('show');
  sidebar.setAttribute('aria-hidden','false');
  btnBurger.setAttribute('aria-expanded','true');
}
function closeSidebar(){
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  sidebar.setAttribute('aria-hidden','true');
  btnBurger.setAttribute('aria-expanded','false');
}
btnBurger.addEventListener('click', ()=> {
  if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
});
overlay.addEventListener('click', closeSidebar);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSidebar(); });

/* Clique nos itens da sidebar para trocar de aba */
sidebar.querySelectorAll('[data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-target');
    setTab(id);
    // estado ativo na sidebar
    sidebar.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    // desktop tabs
    document.querySelectorAll('.nav-tabs button').forEach(b=>{
      b.classList.toggle('active', b.getAttribute('data-tab')===id);
    });
    closeSidebar();
  });
});

/* ===== Tabs (desktop e chamadas internas) ===== */
window.setTab = (id, btn=null)=>{
  document.querySelectorAll(".tab-pane").forEach(p=>p.style.display="none");
  const el = document.getElementById(id);
  if(el) el.style.display="block";
  // Atualiza tabs desktop (se veio de clique na pr√≥pria tab)
  if(btn){
    document.querySelectorAll(".nav-tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
  }
  // Atualiza estado ativo na sidebar tamb√©m
  document.querySelectorAll(".sidebar [data-target]").forEach(b=>{
    b.classList.toggle('active', b.getAttribute('data-target')===id);
  });
};

/* ===== Utils ===== */
function roleLabel(r){
  return ({adm:"ADM",chefe:"Chefe",ose:"OSE",encarregado:"Encarregado",motorista:"Motorista",aux_encarregado:"Aux. Encarregado"}[r]||r);
}
function destinosPorRole(role){
  return ({adm:"adm-dashboard.html",chefe:"chefe-dashboard.html",ose:"ose-dashboard.html",encarregado:"encarregado-dashboard.html",motorista:"motorista-dashboard.html",aux_encarregado:"aux-encarregado-dashboard.html"}[role]||"index.html");
}
function downloadCSV(filename, rows){
  if(!rows.length) return alert("Sem dados.");
  const head = Object.keys(rows[0]).join(";");
  const body = rows.map(r => Object.values(r).map(v=>`"${(v??"").toString().replace(/"/g,'""')}"`).join(";")).join("\n");
  const blob = new Blob([head+"\n"+body], {type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}

/* ===== Logs helper ===== */
async function logAction(acao, alvo, extra={}){
  try{
    await addDoc(collection(db,"logs"), {
      acao, alvo, feito_por_uid: auth.currentUser?.uid || null,
      feito_por_email: auth.currentUser?.email || null,
      data_hora: serverTimestamp(), ...extra
    });
  }catch(e){ console.warn("Falha ao gravar log:", e); }
}

/* ===== Init ===== */
function init(){
  carregarUsuarios();
  carregarMissoesRealtime();
  carregarLogsRealtime();
  carregarEmulacaoRealtime();
}

/* ===== Usu√°rios ===== */
function carregarUsuarios(){
  const tbody = document.getElementById("usuarios-body");
  onSnapshot(collection(db,"usuarios"), (snap)=>{
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const u = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nome||"-"}</td>
        <td>${u.email||"-"}</td>
        <td>${roleLabel(u.role)}</td>
        <td>${u.aprovado?'<span class="badge-ok">Aprovado</span>':'<span class="badge-no">Pendente</span>'}</td>
        <td class="actions">
          <button class="aprovar" onclick="aprovar('${d.id}')">‚úî Aprovar</button>
          <button class="desaprovar" onclick="desaprovar('${d.id}')">‚úñ Desaprovar</button>
          <button class="editar" onclick="editarUsuario('${d.id}','${(u.nome||'').replace(/"/g,'&quot;')}','${u.role||''}')">‚úè Editar</button>
          <button class="reset" onclick="resetSenha('${u.email||''}')">üîÅ Resetar Senha</button>
          <button class="excluir" onclick="excluirUsuario('${d.id}')">üóë Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}
window.aprovar = async(uid)=>{
  await updateDoc(doc(db,"usuarios",uid), {aprovado:true});
  await logAction("Aprovar usu√°rio", uid);
  alert("Usu√°rio aprovado!");
};
window.desaprovar = async(uid)=>{
  await updateDoc(doc(db,"usuarios",uid), {aprovado:false});
  await logAction("Desaprovar usu√°rio", uid);
  alert("Usu√°rio desaprovado!");
};
window.editarUsuario = async (uid, nomeAtual, cargoAtual)=>{
  const novoNome = prompt("Novo nome:", nomeAtual||"")?.trim();
  const novoCargo = prompt("Novo cargo (adm, chefe, ose, encarregado, aux_encarregado, motorista):", cargoAtual||"")?.trim();
  if(!novoNome || !novoCargo) return alert("Edi√ß√£o cancelada.");
  await updateDoc(doc(db,"usuarios",uid), { nome: novoNome, role: novoCargo });
  await logAction("Editar usu√°rio", uid, { nome: novoNome, role: novoCargo });
  alert("Usu√°rio atualizado.");
};
window.resetSenha = async (email)=>{
  if(!email) return alert("Usu√°rio sem e-mail.");
  try{ await sendPasswordResetEmail(auth, email); alert(`Email de redefini√ß√£o enviado para ${email}.`); await logAction("Reset senha", email); }
  catch(e){ alert("Erro ao enviar e-mail de redefini√ß√£o."); }
};
window.excluirUsuario = async (uid)=>{
  if(!confirm("Excluir usu√°rio?")) return;
  await deleteDoc(doc(db,"usuarios",uid));
  await logAction("Excluir usu√°rio", uid);
  alert("Usu√°rio exclu√≠do.");
};

/* ===== Miss√µes ===== */
let MISSOES_CACHE = [];
function assinaturaPill(label, email, hora){
  return email ? `<span class="badge-ok">${email}</span>${hora?`<br><small>${hora}</small>`:""}` : `<span class="badge-no">${label} pendente</span>`;
}
function renderMissoes(list){
  const tbody = document.getElementById("missoes-body");
  tbody.innerHTML = "";
  list.forEach(m=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m.missao||"-"} ${m.fora_programacao?'<span class="tag-fp">‚ö† Fora</span>':""}</td>
      <td>${m.motorista||"-"}</td>
      <td>${m.viatura_label||m.viatura||"-"}</td>
      <td>${m.status||"Pendente"}</td>
      <td>${m.odometro_inicio||"-"}</td>
      <td>${m.horario_inicio||"-"}</td>
      <td>${m.odometro_fim||"-"}</td>
      <td>${m.horario_fim||"-"}</td>
      <td>
        ${assinaturaPill("OSE", m.assinatura_ose, m.hora_assinatura_ose)}<br>
        ${assinaturaPill("Encarregado", m.assinatura_encarregado, m.hora_assinatura_encarregado)}<br>
        ${assinaturaPill("Chefe", m.assinatura_chedep, m.hora_assinatura_chedep)}
      </td>
      <td class="actions">
        <button class="editar" onclick="editarMissao('${m.id}')">‚úè Editar</button>
        <button class="reset" onclick="alterarStatus('${m.id}')">‚Ü∫ Status</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // mant√©m filtros ativos ap√≥s rerender
  filtrarMissoes();
}
function carregarMissoesRealtime(){
  onSnapshot(collection(db,"viaturas_missao"), (snap)=>{
    MISSOES_CACHE = [];
    snap.forEach(d=> MISSOES_CACHE.push({id:d.id, ...d.data()}));
    renderMissoes(MISSOES_CACHE);
  });
}
window.filtrarMissoes = ()=>{
  const st = document.getElementById("filtro-status").value;
  const q = (document.getElementById("busca-missao").value||"").toLowerCase();
  const filtered = MISSOES_CACHE.filter(m=>{
    const okSt = st ? m.status===st : true;
    const okQ = q ? (`${m.missao||""} ${m.motorista||""} ${m.viatura_label||m.viatura||""}`).toLowerCase().includes(q) : true;
    return okSt && okQ;
  });
  const tbody = document.getElementById("missoes-body");
  tbody.innerHTML = "";
  filtered.forEach(m=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${m.missao||"-"} ${m.fora_programacao?'<span class="tag-fp">‚ö† Fora</span>':""}</td>
      <td>${m.motorista||"-"}</td>
      <td>${m.viatura_label||m.viatura||"-"}</td>
      <td>${m.status||"Pendente"}</td>
      <td>${m.odometro_inicio||"-"}</td>
      <td>${m.horario_inicio||"-"}</td>
      <td>${m.odometro_fim||"-"}</td>
      <td>${m.horario_fim||"-"}</td>
      <td>
        ${assinaturaPill("OSE", m.assinatura_ose, m.hora_assinatura_ose)}<br>
        ${assinaturaPill("Encarregado", m.assinatura_encarregado, m.hora_assinatura_encarregado)}<br>
        ${assinaturaPill("Chefe", m.assinatura_chedep, m.hora_assinatura_chedep)}
      </td>
      <td class="actions">
        <button class="editar" onclick="editarMissao('${m.id}')">‚úè Editar</button>
        <button class="reset" onclick="alterarStatus('${m.id}')">‚Ü∫ Status</button>
      </td>`;
    tbody.appendChild(tr);
  });
};
window.editarMissao = async(id)=>{
  const ref = doc(db,"viaturas_missao",id);
  const d = await getDoc(ref); if(!d.exists()) return;
  const m = d.data();
  const missao = prompt("Miss√£o:", m.missao||""); if(missao===null) return;
  const motorista = prompt("Motorista:", m.motorista||""); if(motorista===null) return;
  const viatura_label = prompt("Viatura (label):", m.viatura_label||""); if(viatura_label===null) return;
  await updateDoc(ref, { missao, motorista, viatura_label });
  await logAction("Editar miss√£o", id);
  alert("Miss√£o atualizada.");
};
window.alterarStatus = async(id)=>{
  const status = prompt("Novo status (Pendente, Aprovada pela OSE, Negada pela OSE, Em viagem, Conclu√≠da):",""); if(!status) return;
  await updateDoc(doc(db,"viaturas_missao",id), { status });
  await logAction("Alterar status miss√£o", id, {status});
  alert("Status atualizado.");
};

/* ===== Logs ===== */
let LOGS_CACHE = [];
function carregarLogsRealtime(){
  onSnapshot(query(collection(db,"logs"), orderBy("data_hora","desc")), (snap)=>{
    LOGS_CACHE = [];
    const tbody = document.getElementById("logs-body");
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const l = d.data();
      const row = {
        acao: l.acao || "", alvo: l.alvo || "",
        feito_por: l.feito_por_email || "",
        data_hora: l.data_hora?.toDate ? l.data_hora.toDate().toLocaleString() : ""
      };
      LOGS_CACHE.push(row);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${row.acao}</td><td>${row.alvo}</td><td>${row.feito_por}</td><td>${row.data_hora}</td>`;
      tbody.appendChild(tr);
    });
    filtrarLogs();
  });
}
window.filtrarLogs = ()=>{
  const termo = (document.getElementById("busca-logs").value||"").toLowerCase();
  Array.from(document.querySelectorAll("#logs-body tr")).forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(termo) ? "" : "none";
  });
};
window.exportarLogs = ()=> downloadCSV(`logs_${new Date().toISOString().slice(0,10)}.csv`, LOGS_CACHE);

/* ===== Emula√ß√£o ===== */
function carregarEmulacaoRealtime(){
  const tbody = document.getElementById("emulacao-body");
  onSnapshot(collection(db,"usuarios"), (snap)=>{
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const u = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nome||"-"}</td>
        <td>${u.email||"-"}</td>
        <td>${roleLabel(u.role)}</td>
        <td><button class="editar" onclick="emularPerfil('${u.email||''}','${u.role||''}')">Emular</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
window.emularPerfil = (email, role)=>{
  if(!email || !role) return alert("Usu√°rio inv√°lido para emula√ß√£o.");
  const destino = destinosPorRole(role);
  window.location.href = `${destino}?emulando=${encodeURIComponent(email)}`;
};
</script>
</body>
</html>
