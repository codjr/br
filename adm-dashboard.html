<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administrador - Dashboard</title>

<link rel="icon" type="image/svg+xml"
      href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
/* ==========================================================
   UI FUTURISTA PREMIUM 2025 ‚Äî ADMINISTRADOR MARINHA
   Tema institucional azul-naval + modo escuro autom√°tico
========================================================== */
:root {
  --cor-primaria:#004aad;
  --cor-primaria-hover:#003b8e;
  --cor-fundo:#f5f7fa;
  --cor-texto:#1f2937;
  --cor-card:#ffffff;
  --cor-borda:#d1d5db;
  --cor-secundaria:#e2e8f0;
  --cor-sucesso:#16a34a;
  --cor-erro:#dc2626;
  --cor-aviso:#f59e0b;
}
@media(prefers-color-scheme:dark){
  :root{
    --cor-fundo:#0b1120;--cor-card:#111827;--cor-texto:#e5e7eb;
    --cor-borda:#1f2937;--cor-secundaria:#1e293b;
  }
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);
  min-height:100vh;display:flex;justify-content:center;padding:30px 10px;}
.container{
  width:100%;max-width:1250px;background:var(--cor-card);
  border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.12);padding:24px;
}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.logo-marinha{display:flex;align-items:center;gap:12px}
.logo-marinha img{width:50px;height:50px}
header h1{color:var(--cor-primaria);font-size:1.35rem;margin:0}
header button{
  background:var(--cor-erro);color:#fff;border:none;
  padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;transition:.25s;
}
header button:hover{background:#b91c1c}
.nav-tabs{display:flex;gap:8px;margin:12px 0 18px;flex-wrap:wrap}
.nav-tabs button{
  background:var(--cor-secundaria);border:1px solid var(--cor-borda);color:var(--cor-texto);
  padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;
}
.nav-tabs button.active{background:var(--cor-primaria);color:#fff;border-color:var(--cor-primaria)}
.table-wrap{overflow:auto;border:1px solid var(--cor-borda);border-radius:10px}
table{width:100%;border-collapse:collapse;min-width:980px}
thead{background:var(--cor-primaria);color:#fff}
th,td{padding:10px 12px;border-bottom:1px solid var(--cor-borda);text-align:left}
tbody tr:hover{background:rgba(0,74,173,.05)}
button{transition:0.2s}
button.aprovar{background:var(--cor-sucesso);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.aprovar:hover{background:#15803d}
button.editar{background:var(--cor-aviso);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.editar:hover{background:#b45309}
button.reset{background:var(--cor-secundaria);color:var(--cor-texto);border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.reset:hover{filter:brightness(.9)}
button.excluir{background:var(--cor-erro);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.excluir:hover{background:#b91c1c}
.badge-ok{display:inline-block;background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700}
.badge-no{display:inline-block;background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700}
.tag-fp{color:#dc2626;font-weight:700}
@media(max-width:768px){header{flex-direction:column;gap:10px;align-items:flex-start}
.container{padding:18px}th,td{font-size:.92rem}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo-marinha">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="Marinha do Brasil">
      <h1>Administrador ‚Äî Sistema de Viaturas</h1>
    </div>
    <button onclick="logout()">Sair</button>
  </header>

  <div class="nav-tabs">
    <button class="active" data-tab="tab-usuarios" onclick="setTab('tab-usuarios', this)">Usu√°rios</button>
    <button data-tab="tab-missoes" onclick="setTab('tab-missoes', this)">Miss√µes</button>
    <button data-tab="tab-logs" onclick="setTab('tab-logs', this)">Logs</button>
    <button data-tab="tab-emulacao" onclick="setTab('tab-emulacao', this)">Emula√ß√£o</button>
  </div>

  <!-- Usu√°rios -->
  <section id="tab-usuarios" style="display:block;">
    <h2>Gerenciamento de Usu√°rios</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
        <tbody id="usuarios-body"></tbody>
      </table>
    </div>
  </section>

  <!-- Miss√µes -->
  <section id="tab-missoes" style="display:none;">
    <h2>Miss√µes (todas)</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th><th>Fora Prog.</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody id="missoes-body"></tbody>
      </table>
    </div>
  </section>

  <!-- Logs -->
  <section id="tab-logs" style="display:none;">
    <h2>Logs do Sistema</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>A√ß√£o</th><th>Alvo</th><th>Feito por</th><th>Data/Hora</th></tr></thead>
        <tbody id="logs-body"></tbody>
      </table>
    </div>
  </section>

  <!-- Emula√ß√£o -->
  <section id="tab-emulacao" style="display:none;">
    <h2>Emular Perfis</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th><th>A√ß√£o</th></tr></thead>
        <tbody id="emulacao-body"></tbody>
      </table>
    </div>
  </section>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* Prote√ß√£o e logout autom√°tico */
const TEMPO_MAX_MS = 10*60*1000;let timer;
onAuthStateChanged(auth,u=>{
  if(!u){window.location.href="index.html";}
  else{reiniciar();["mousemove","keydown","click"].forEach(e=>document.addEventListener(e,reiniciar));}
});
function reiniciar(){clearTimeout(timer);
  timer=setTimeout(async()=>{alert("‚è∞ Sess√£o encerrada.");await signOut(auth);window.location.href="index.html";},TEMPO_MAX_MS);
}

/* Tabs */
window.setTab=(id,btn)=>{
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".nav-tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
};

/* Logout */
window.logout=async()=>{await signOut(auth);window.location.href="index.html";}

/* Fun√ß√µes utilit√°rias */
function roleLabel(r){
  return ({adm:"Administrador",chefe:"Chefe",ose:"OSE",encarregado:"Encarregado",aux_encarregado:"Aux. Encarregado",motorista:"Motorista"}[r]||r);
}
function destinosPorRole(role){
  return ({adm:"adm-dashboard.html",chefe:"chefe-dashboard.html",ose:"ose-dashboard.html",
           encarregado:"encarregado-dashboard.html",aux_encarregado:"aux-encarregado-dashboard.html",
           motorista:"motorista-dashboard.html"}[role]||"index.html");
}

/* Usu√°rios em tempo real */
onSnapshot(collection(db,"usuarios"),snap=>{
  const tbody=document.getElementById("usuarios-body");
  const emuBody=document.getElementById("emulacao-body");
  tbody.innerHTML="";emuBody.innerHTML="";
  snap.forEach(d=>{
    const u=d.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${u.nome||"-"}</td>
      <td>${u.email||"-"}</td>
      <td>${roleLabel(u.role)}</td>
      <td>${u.aprovado?'<span class="badge-ok">Aprovado</span>':'<span class="badge-no">Pendente</span>'}</td>
      <td>
        <button class="aprovar" onclick="aprovar('${d.id}')">‚úî</button>
        <button class="editar" onclick="editarUsuario('${d.id}','${u.nome}','${u.role}')">‚úè</button>
        <button class="reset" onclick="resetSenha('${u.email}')">üîÅ</button>
        <button class="excluir" onclick="excluirUsuario('${d.id}')">üóë</button>
      </td>`;
    tbody.appendChild(tr);

    const tr2=document.createElement("tr");
    tr2.innerHTML=`
      <td>${u.nome||"-"}</td><td>${u.email||"-"}</td><td>${roleLabel(u.role)}</td>
      <td><button class="editar" onclick="emular('${u.email}','${u.role}')">Emular</button></td>`;
    emuBody.appendChild(tr2);
  });
});

/* A√ß√µes b√°sicas */
window.aprovar=async uid=>{await updateDoc(doc(db,"usuarios",uid),{aprovado:true});alert("‚úÖ Usu√°rio aprovado.");};
window.editarUsuario=async(uid,nome,cargo)=>{
  const novoNome=prompt("Novo nome:",nome);
  const novoCargo=prompt("Novo cargo (adm, chefe, ose, encarregado, aux_encarregado, motorista):",cargo);
  if(!novoNome||!novoCargo)return;
  await updateDoc(doc(db,"usuarios",uid),{nome:novoNome,role:novoCargo});
  alert("‚úè Usu√°rio atualizado.");
};
window.resetSenha=async email=>{
  await sendPasswordResetEmail(auth,email);
  alert("üîÅ E-mail de redefini√ß√£o enviado para "+email);
};
window.excluirUsuario=async uid=>{
  if(confirm("Excluir este usu√°rio?")){
    await deleteDoc(doc(db,"usuarios",uid));
    alert("üóë Usu√°rio exclu√≠do.");
  }
};

/* Emula√ß√£o */
window.emular=(email,role)=>{
  const destino=destinosPorRole(role);
  window.location.href=`${destino}?emulando=${encodeURIComponent(email)}`;
};

/* Miss√µes (leitura simples) */
onSnapshot(collection(db,"viaturas_missao"),snap=>{
  const tb=document.getElementById("missoes-body");
  tb.innerHTML="";
  snap.forEach(d=>{
    const m=d.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m.missao||"-"}</td><td>${m.motorista||"-"}</td>
      <td>${m.viatura||"-"}</td><td>${m.status||"-"}</td>
      <td>${m.fora_programacao?"‚ö† Sim":"N√£o"}</td>
      <td><button class="editar" onclick="editarMissao('${d.id}')">‚úè</button></td>`;
    tb.appendChild(tr);
  });
});
window.editarMissao=async id=>{
  const ref=doc(db,"viaturas_missao",id);
  const missao=prompt("Nova descri√ß√£o da miss√£o:");
  if(missao){await updateDoc(ref,{missao});alert("Miss√£o atualizada.");}
};

/* Logs (simplificado) */
onSnapshot(collection(db,"logs"),snap=>{
  const tb=document.getElementById("logs-body");
  tb.innerHTML="";
  snap.forEach(d=>{
    const l=d.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${l.acao||""}</td><td>${l.alvo||""}</td><td>${l.feito_por_email||""}</td><td>${l.data_hora||""}</td>`;
    tb.appendChild(tr);
  });
});
</script>
</body>
</html>
