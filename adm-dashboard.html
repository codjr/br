<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administrador - Dashboard</title>

<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
/* ==========================================================
   UI FUTURISTA PREMIUM 2025 ‚Äî ADMINISTRADOR MARINHA
   Tema institucional azul-naval + modo escuro autom√°tico
========================================================== */
:root {
  --cor-primaria: #004aad;
  --cor-primaria-hover: #003b8e;
  --cor-fundo: #f5f7fa;
  --cor-texto: #1f2937;
  --cor-card: #ffffff;
  --cor-borda: #d1d5db;
  --cor-secundaria: #e2e8f0;
  --cor-sucesso: #16a34a;
  --cor-erro: #dc2626;
  --cor-aviso: #f59e0b;
}
@media (prefers-color-scheme: dark) {
  :root {
    --cor-fundo: #0b1120;
    --cor-card: #111827;
    --cor-texto: #e5e7eb;
    --cor-borda: #1f2937;
    --cor-secundaria: #1e293b;
  }
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{
  margin:0;background:var(--cor-fundo);color:var(--cor-texto);
  min-height:100vh;display:flex;justify-content:center;padding:30px 10px;
}
.container{
  width:100%;max-width:1250px;background:var(--cor-card);
  border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.12);padding:24px;
}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.logo-marinha{display:flex;align-items:center;gap:12px}
.logo-marinha img{width:50px;height:50px}
header h1{color:var(--cor-primaria);font-size:1.35rem;margin:0}
header button{
  background:var(--cor-erro);color:#fff;border:none;
  padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;transition:.25s;
}
header button:hover{background:#b91c1c}

#emulacao-banner{
  display:none;background:#004aad;color:#fff;padding:10px 20px;text-align:center;
  font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.2);margin:-20px -20px 10px -20px;border-radius:8px 8px 0 0;
}

.nav-tabs{display:flex;gap:8px;margin:12px 0 18px;flex-wrap:wrap}
.nav-tabs button{
  background:var(--cor-secundaria);border:1px solid var(--cor-borda);color:var(--cor-texto);
  padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;
}
.nav-tabs button.active{background:var(--cor-primaria);color:#fff;border-color:var(--cor-primaria)}

h2{color:var(--cor-primaria);margin:0 0 8px;border-left:4px solid var(--cor-primaria);padding-left:10px}

.table-wrap{overflow:auto;border:1px solid var(--cor-borda);border-radius:10px}
table{width:100%;border-collapse:collapse;min-width:980px}
thead{background:var(--cor-primaria);color:#fff}
th,td{padding:10px 12px;border-bottom:1px solid var(--cor-borda);text-align:left}
tbody tr:hover{background:rgba(0,74,173,.05)}

.actions{display:flex;flex-wrap:wrap;gap:6px}
button.aprovar{background:var(--cor-sucesso);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.aprovar:hover{background:#15803d}
button.editar{background:var(--cor-aviso);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.editar:hover{background:#b45309}
button.reset{background:var(--cor-secundaria);color:var(--cor-texto);border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.reset:hover{filter:brightness(.9)}
button.excluir{background:var(--cor-erro);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:600}
button.excluir:hover{background:#b91c1c}

.badge-ok{display:inline-block;background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700}
.badge-no{display:inline-block;background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700}
.badge-warn{display:inline-block;background:rgba(245,158,11,.12);color:#92400e;padding:4px 8px;border-radius:6px;font-weight:700}
.tag-fp{color:#dc2626;font-weight:700}

.filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
.filters input,.filters select{padding:8px 10px;border:1px solid var(--cor-borda);border-radius:8px;background:#fff}

@media (max-width:768px){
  header{flex-direction:column;gap:10px;align-items:flex-start}
  .container{padding:18px}
  th,td{font-size:.92rem}
  .nav-tabs{gap:6px}
  .nav-tabs button{padding:7px 10px}
}
</style>
</head>
<body>
  <div class="container">
    <!-- Banner se o ADM tamb√©m estiver emulado -->
    <div id="emulacao-banner">
      üîß Modo Emula√ß√£o Ativo ‚Äî <span id="emulando-email"></span>
      <button onclick="window.location.href='adm-dashboard.html'"
              style="margin-left:10px;background:#fbbf24;color:#000;border:none;
                     padding:6px 10px;border-radius:5px;cursor:pointer;font-weight:600;">
        Voltar ao ADM
      </button>
    </div>

    <header>
      <div class="logo-marinha">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg" alt="Marinha do Brasil">
        <h1>Administrador ‚Äî Sistema de Viaturas</h1>
      </div>
      <button onclick="logout()">Sair</button>
    </header>

    <div class="nav-tabs">
      <button class="active" data-tab="tab-usuarios" onclick="setTab('tab-usuarios', this)">Usu√°rios</button>
      <button data-tab="tab-missoes" onclick="setTab('tab-missoes', this)">Miss√µes</button>
      <button data-tab="tab-logs" onclick="setTab('tab-logs', this)">Logs do Sistema</button>
      <button data-tab="tab-emulacao" onclick="setTab('tab-emulacao', this)">Emula√ß√£o</button>
    </div>

    <!-- ===== Usu√°rios ===== -->
    <section id="tab-usuarios" class="tab-pane" style="display:block;">
      <h2>Gerenciamento de Usu√°rios</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nome</th><th>Email</th><th>Cargo</th><th>Status</th><th style="min-width:380px">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="usuarios-body"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== Miss√µes ===== -->
    <section id="tab-missoes" class="tab-pane" style="display:none;">
      <h2>Miss√µes (todas)</h2>
      <div class="filters">
        <select id="filtro-status" onchange="filtrarMissoes()">
          <option value="">Status: Todos</option>
          <option value="Pendente">Pendente</option>
          <option value="Aprovada">Aprovada</option>
          <option value="Negada">Negada</option>
          <option value="Em viagem">Em viagem</option>
          <option value="Conclu√≠da">Conclu√≠da</option>
          <option value="Confirmada pelo P3">Confirmada pelo P3</option>
        </select>
        <input id="busca-missao" type="search" placeholder="Buscar por miss√£o/viatura/motorista..." oninput="filtrarMissoes()"/>
        <span class="badge-warn">‚ö† Fora da Programa√ß√£o aparece destacado</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th>
              <th>Od√¥metro In√≠cio</th><th>Hor√°rio In√≠cio</th>
              <th>Od√¥metro Fim</th><th>Hor√°rio Fim</th>
              <th>Assinaturas</th>
              <th style="min-width:220px">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="missoes-body"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== Logs ===== -->
    <section id="tab-logs" class="tab-pane" style="display:none;">
      <h2>Logs do Sistema</h2>
      <div class="filters">
        <input id="busca-logs" type="search" placeholder="Buscar por a√ß√£o, alvo, e-mail..." oninput="filtrarLogs()"/>
        <button class="reset" onclick="exportarLogs()">Exportar CSV</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>A√ß√£o</th><th>Alvo</th><th>Feito por</th><th>Data/Hora</th></tr>
          </thead>
          <tbody id="logs-body"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== Emula√ß√£o ===== -->
    <section id="tab-emulacao" class="tab-pane" style="display:none;">
      <h2>Emula√ß√£o de Perfil</h2>
      <div class="filters">
        <input id="busca-emulacao" type="search" placeholder="Buscar usu√°rio por nome/email..." oninput="filtrarEmulacao()"/>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Nome</th><th>Email</th><th>Cargo</th><th>A√ß√£o</th></tr>
          </thead>
          <tbody id="emulacao-body"></tbody>
        </table>
      </div>
      <p class="badge-warn" style="margin-top:8px;">‚öô Ao emular, voc√™ ser√° redirecionado para o dashboard do cargo com <b>?emulando=email</b>.</p>
    </section>
  </div>

  <script type="module">
  import { auth, db } from "./firebase-config.js";
  import { signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import {
    collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  /* ========= üîí Prote√ß√£o + logout autom√°tico (10 min) ========= */
  const TEMPO_MAX_MS = 10 * 60 * 1000;
  let timerLogout;
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      resetInatividade();
      ["mousemove","keydown","click","scroll"].forEach(evt => document.addEventListener(evt, resetInatividade));
    }
  });
  function resetInatividade(){
    clearTimeout(timerLogout);
    timerLogout = setTimeout(async ()=>{
      alert("‚è∞ Sess√£o expirada por inatividade.");
      await signOut(auth);
      window.location.href = "index.html";
    }, TEMPO_MAX_MS);
  }

  /* ========= üîß Banner de Emula√ß√£o (se abrirem o ADM emulado) ========= */
  const params = new URLSearchParams(window.location.search);
  const emulando = params.get("emulando");
  if (emulando) {
    const b = document.getElementById("emulacao-banner");
    b.style.display = "block";
    document.getElementById("emulando-email").textContent = emulando;
  }

  /* ========= Tabs ========= */
  window.setTab = (id, btn) => {
    document.querySelectorAll(".tab-pane").forEach(p => p.style.display = "none");
    document.getElementById(id).style.display = "block";
    document.querySelectorAll(".nav-tabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  };

  /* ========= Logout ========= */
  window.logout = async () => { await signOut(auth); window.location.href = "index.html"; };

  /* ========= Utils ========= */
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  function roleLabel(r){ return ({adm:"ADM",chefe:"Chefe",ose:"OSE",encarregado:"Encarregado",motorista:"Motorista",aux_p3:"Auxiliar P3"}[r] || r); }
  function destinosPorRole(role){
    return ({adm:"adm-dashboard.html",chefe:"chefe-dashboard.html",ose:"ose-dashboard.html",encarregado:"encarregado-dashboard.html",motorista:"motorista-dashboard.html",aux_p3:"p3-dashboard.html"}[role] || "index.html");
  }
  function downloadCSV(filename, rows){
    if(!rows.length) return alert("Sem dados para exportar.");
    const csv = [
      Object.keys(rows[0]).join(";"),
      ...rows.map(r => Object.values(r).map(v => `"${(v??"").toString().replace(/"/g,'""')}"`).join(";"))
    ].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
  }

  /* ========= LOG helper ========= */
  async function logAction(acao, alvo, extra={}){
    try{
      await addDoc(collection(db,"logs"), {
        acao, alvo,
        feito_por_uid: auth.currentUser?.uid || null,
        feito_por_email: auth.currentUser?.email || null,
        data_hora: serverTimestamp(),
        ...extra
      });
    }catch(e){ console.warn("Falha ao gravar log:", e); }
  }

  /* ===================== USU√ÅRIOS (Realtime) ===================== */
  function carregarUsuarios(){
    const tbody = $("#usuarios-body");
    const emuBody = $("#emulacao-body");

    onSnapshot(collection(db,"usuarios"), (snap)=>{
      tbody.innerHTML = "";
      emuBody.innerHTML = "";

      snap.forEach(docItem=>{
        const u = docItem.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.nome || "-"}</td>
          <td>${u.email || "-"}</td>
          <td>${roleLabel(u.role)}</td>
          <td>${u.aprovado ? '<span class="badge-ok">Aprovado</span>' : '<span class="badge-no">Pendente</span>'}</td>
          <td class="actions">
            <button class="aprovar" onclick="aprovar('${docItem.id}')">‚úî Aprovar</button>
            <button class="editar" onclick="editarUsuario('${docItem.id}','${(u.nome||'').replace(/"/g,'&quot;')}','${u.role||''}')">‚úè Editar</button>
            <button class="reset" onclick="resetSenha('${u.email||''}')">üîÅ Resetar Senha</button>
            <button class="excluir" onclick="excluirUsuario('${docItem.id}')">üóë Excluir</button>
          </td>`;
        tbody.appendChild(tr);

        const tr2 = document.createElement("tr");
        tr2.innerHTML = `
          <td>${u.nome || "-"}</td>
          <td>${u.email || "-"}</td>
          <td>${roleLabel(u.role)}</td>
          <td><button class="editar" onclick="emularPerfil('${u.email||''}','${u.role||''}')">Emular</button></td>`;
        emuBody.appendChild(tr2);
      });
    });
  }
  window.onload = carregarUsuarios;

  window.aprovar = async (uid) => {
    await updateDoc(doc(db,"usuarios",uid), { aprovado: true });
    await logAction("Aprovar usu√°rio", uid);
    alert("‚úÖ Usu√°rio aprovado!");
  };
  window.editarUsuario = async (uid, nomeAtual, cargoAtual) => {
    const novoNome = prompt("Novo nome:", nomeAtual || "")?.trim();
    const novoCargo = prompt("Novo cargo (adm, chefe, ose, encarregado, motorista, aux_p3):", cargoAtual || "")?.trim();
    if(!novoNome || !novoCargo) return alert("‚ö†Ô∏è Edi√ß√£o cancelada.");
    await updateDoc(doc(db,"usuarios",uid), { nome: novoNome, role: novoCargo });
    await logAction("Editar usu√°rio", uid, { nome: novoNome, role: novoCargo });
    alert("‚úè Usu√°rio atualizado!");
  };
  window.resetSenha = async (email) => {
    if(!email) return alert("Usu√°rio sem e-mail.");
    try{ await sendPasswordResetEmail(auth, email); alert(`üîÅ E-mail de redefini√ß√£o enviado para ${email}.`); await logAction("Reset de senha", email); }
    catch(e){ console.error(e); alert("‚ùå Erro ao enviar e-mail de redefini√ß√£o."); }
  };
  window.excluirUsuario = async (uid) => {
    if(!confirm("Excluir usu√°rio? Esta a√ß√£o √© irrevers√≠vel.")) return;
    await deleteDoc(doc(db,"usuarios",uid));
    await logAction("Excluir usu√°rio", uid);
    alert("üóë Usu√°rio exclu√≠do.");
  };

  /* ===================== MISS√ïES (Realtime + Filtro) ===================== */
  let MISSOES_CACHE = [];
  onSnapshot(collection(db,"viaturas_missao"), (snap)=>{
    MISSOES_CACHE = [];
    snap.forEach(docItem=> MISSOES_CACHE.push({ id: docItem.id, ...docItem.data() }));
    renderMissoes(MISSOES_CACHE);
  });

  function assinaturaPill(label, email, hora){
    return email
      ? `<span class="badge-ok">${email}</span>${hora?`<br><small>${hora}</small>`:""}`
      : `<span class="badge-no">${label} pendente</span>`;
  }

  function renderMissoes(list){
    const tbody = $("#missoes-body");
    tbody.innerHTML = "";
    list.forEach(m=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.missao || "-"} ${m.fora_programacao ? "<span class='tag-fp'>‚ö† Fora da Programa√ß√£o</span>" : ""}</td>
        <td>${m.motorista || "-"}</td>
        <td>${m.viatura || "-"}</td>
        <td>${m.status || "-"}</td>
        <td>${m.odometro_inicio || "-"}</td>
        <td>${m.horario_inicio || "-"}</td>
        <td>${m.odometro_fim || "-"}</td>
        <td>${m.horario_fim || "-"}</td>
        <td>
          ${assinaturaPill("OSE", m.assinatura_ose, m.hora_assinatura_ose)}<br>
          ${assinaturaPill("Encarregado", m.assinatura_encarregado, m.hora_assinatura_encarregado)}<br>
          ${assinaturaPill("Chefe", m.assinatura_chedep, m.hora_assinatura_chedep)}<br>
          ${assinaturaPill("P3", m.assinatura_p3, m.hora_assinatura_p3)}
        </td>
        <td class="actions">
          <button class="editar" onclick="editarMissao('${m.id}')">‚úè Editar</button>
          <button class="reset" onclick="alterarStatus('${m.id}')">‚Ü∫ Status</button>
        </td>`;
      tbody.appendChild(tr);
    });
    filtrarMissoes();
  }

  window.filtrarMissoes = () => {
    const st = $("#filtro-status").value;
    const q = ($("#busca-missao").value || "").toLowerCase();
    const filtradas = MISSOES_CACHE.filter(m=>{
      const okStatus = st ? (m.status === st) : true;
      const txt = `${m.missao||""} ${m.motorista||""} ${m.viatura||""}`.toLowerCase();
      const okQuery = q ? txt.includes(q) : true;
      return okStatus && okQuery;
    });
    const tbody = $("#missoes-body");
    tbody.innerHTML = "";
    filtradas.forEach(m=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.missao || "-"} ${m.fora_programacao ? "<span class='tag-fp'>‚ö† Fora da Programa√ß√£o</span>" : ""}</td>
        <td>${m.motorista || "-"}</td>
        <td>${m.viatura || "-"}</td>
        <td>${m.status || "-"}</td>
        <td>${m.odometro_inicio || "-"}</td>
        <td>${m.horario_inicio || "-"}</td>
        <td>${m.odometro_fim || "-"}</td>
        <td>${m.horario_fim || "-"}</td>
        <td>
          ${assinaturaPill("OSE", m.assinatura_ose, m.hora_assinatura_ose)}<br>
          ${assinaturaPill("Encarregado", m.assinatura_encarregado, m.hora_assinatura_encarregado)}<br>
          ${assinaturaPill("Chefe", m.assinatura_chedep, m.hora_assinatura_chedep)}<br>
          ${assinaturaPill("P3", m.assinatura_p3, m.hora_assinatura_p3)}
        </td>
        <td class="actions">
          <button class="editar" onclick="editarMissao('${m.id}')">‚úè Editar</button>
          <button class="reset" onclick="alterarStatus('${m.id}')">‚Ü∫ Status</button>
        </td>`;
      tbody.appendChild(tr);
    });
  };

  window.editarMissao = async (id) => {
    const ref = doc(db,"viaturas_missao",id);
    const d = await getDoc(ref); if(!d.exists()) return;
    const m = d.data();

    const missao = prompt("Miss√£o:", m.missao || ""); if(missao===null) return;
    const motorista = prompt("Motorista:", m.motorista || ""); if(motorista===null) return;
    const viatura = prompt("Viatura:", m.viatura || ""); if(viatura===null) return;
    const odIni = prompt("Od√¥metro in√≠cio:", m.odometro_inicio || ""); if(odIni===null) return;
    const hrIni = prompt("Hor√°rio in√≠cio:", m.horario_inicio || ""); if(hrIni===null) return;
    const odFim = prompt("Od√¥metro fim:", m.odometro_fim || ""); if(odFim===null) return;
    const hrFim = prompt("Hor√°rio fim:", m.horario_fim || ""); if(hrFim===null) return;

    await updateDoc(ref, {
      missao, motorista, viatura, odometro_inicio: odIni, horario_inicio: hrIni,
      odometro_fim: odFim, horario_fim: hrFim
    });
    await logAction("Editar miss√£o", id);
    alert("‚úè Miss√£o atualizada.");
  };

  window.alterarStatus = async (id) => {
    const status = prompt("Novo status (Pendente, Aprovada, Negada, Em viagem, Conclu√≠da, Confirmada pelo P3):",""); if(!status) return;
    await updateDoc(doc(db,"viaturas_missao",id), { status });
    await logAction("Alterar status miss√£o", id, {status});
    alert("‚Ü∫ Status atualizado.");
  };

  /* ===================== LOGS (Realtime + Export) ===================== */
  let LOGS_CACHE = [];
  onSnapshot(query(collection(db,"logs"), orderBy("data_hora","desc")), (snap)=>{
    LOGS_CACHE = [];
    const tbody = $("#logs-body");
    tbody.innerHTML = "";
    snap.forEach(docItem=>{
      const l = docItem.data();
      const row = {
        acao: l.acao || "",
        alvo: l.alvo || "",
        feito_por: l.feito_por_email || "",
        data_hora: l.data_hora?.toDate ? l.data_hora.toDate().toLocaleString() : ""
      };
      LOGS_CACHE.push(row);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${row.acao}</td><td>${row.alvo}</td><td>${row.feito_por}</td><td>${row.data_hora}</td>`;
      tbody.appendChild(tr);
    });
    filtrarLogs();
  });

  window.filtrarLogs = () => {
    const termo = ($("#busca-logs").value || "").toLowerCase();
    $$("#logs-body tr").forEach(tr=>{
      tr.style.display = tr.innerText.toLowerCase().includes(termo) ? "" : "none";
    });
  };
  window.exportarLogs = () => {
    downloadCSV(`logs_${new Date().toISOString().slice(0,10)}.csv`, LOGS_CACHE);
  };

  /* ===================== Emula√ß√£o ===================== */
  window.emularPerfil = (email, role) => {
    if(!email || !role) return alert("Usu√°rio inv√°lido para emula√ß√£o.");
    const destino = destinosPorRole(role);
    window.location.href = `${destino}?emulando=${encodeURIComponent(email)}`;
  };
  window.filtrarEmulacao = () => {
    const termo = ($("#busca-emulacao").value || "").toLowerCase();
    $$("#emulacao-body tr").forEach(tr=>{
      tr.style.display = tr.innerText.toLowerCase().includes(termo) ? "" : "none";
    });
  };
  </script>
</body>
</html>
