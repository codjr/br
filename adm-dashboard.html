<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administrador - Dashboard</title>
<link rel="icon" type="image/svg+xml" href="<img src="https://raw.githubusercontent.com/codjr/br/main/heraldica-8DN.png" alt="Marinha do Brasil">
">

<style>
/* ===== RESET E BASE ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Inter", "Segoe UI", Roboto, sans-serif;
}

body {
  background: #edf1f7;
  color: #1a1a1a;
  min-height: 100vh;
}

/* ===== CONTAINER ===== */
.container {
  max-width: 1250px;
  margin: 30px auto;
  padding: 0 20px;
}

/* ===== HEADER ===== */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(90deg, #001f3f, #003366);
  color: #fff;
  padding: 14px 26px;
  border-radius: 10px;
  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
}

header .logo-marinha {
  display: flex;
  align-items: center;
  gap: 15px;
}

header .logo-marinha img {
  width: 54px;
  height: 54px;
}

header h1 {
  font-size: 1.4rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

header button {
  background: #ff4040;
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: 0.2s;
}
header button:hover {
  background: #d32f2f;
  transform: scale(1.05);
}

/* ===== NAV TABS ===== */
.nav-tabs {
  display: flex;
  margin: 20px 0;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 5px rgba(0,0,0,0.1);
}

.nav-tabs button {
  flex: 1;
  padding: 12px;
  background: #f2f4f8;
  border: none;
  cursor: pointer;
  font-weight: 600;
  color: #003366;
  transition: 0.2s;
}
.nav-tabs button:hover {
  background: #e3e9f1;
}
.nav-tabs button.active {
  background: #003366;
  color: #fff;
  box-shadow: inset 0 -4px 0 #c9a600;
}

/* ===== TÍTULOS ===== */
h2 {
  margin-bottom: 16px;
  font-size: 1.3rem;
  color: #002147;
  border-left: 6px solid #c9a600;
  padding-left: 10px;
}

/* ===== FILTROS ===== */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 15px;
}

.filters input,
.filters select {
  padding: 9px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.95rem;
  background: white;
  transition: border 0.2s, box-shadow 0.2s;
}
.filters input:focus,
.filters select:focus {
  outline: none;
  border-color: #003366;
  box-shadow: 0 0 0 2px rgba(0,51,102,0.2);
}

.filters .reset {
  background: #003366;
  color: white;
  border: none;
  padding: 9px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s, transform 0.1s;
}
.filters .reset:hover {
  background: #002147;
  transform: scale(1.03);
}

/* ===== TABELAS ===== */
.table-wrap {
  background: white;
  border-radius: 10px;
  overflow-x: auto;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: #003366;
  color: #fff;
}
th {
  padding: 12px;
  text-align: left;
  font-size: 0.9rem;
  letter-spacing: 0.3px;
}
td {
  padding: 11px 12px;
  border-bottom: 1px solid #e5e8ed;
  font-size: 0.92rem;
}
tr:hover td {
  background: #f9fbfd;
}

/* ===== AÇÕES ===== */
.actions button {
  margin: 2px;
  padding: 6px 10px;
  border-radius: 5px;
  font-size: 0.85rem;
  border: none;
  cursor: pointer;
  transition: all 0.15s;
}

.actions button:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

button.aprovar { background: #2e7d32; color: white; }
button.desaprovar { background: #b71c1c; color: white; }
button.editar { background: #1565c0; color: white; }
button.reset { background: #fbc02d; color: #222; }
button.excluir { background: #c62828; color: white; }

/* ===== BADGES ===== */
.badge-ok {
  background: #2e7d32;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
}
.badge-no {
  background: #d32f2f;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
}
.badge-warn {
  background: #ffb300;
  color: #222;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.85rem;
}

/* ===== TAGS ===== */
.tag-fp {
  background: #ff9800;
  color: white;
  padding: 3px 6px;
  font-size: 0.75rem;
  border-radius: 4px;
  margin-left: 4px;
}

/* ===== TABS ===== */
.tab-pane {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 800px) {
  header {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  header h1 {
    font-size: 1.1rem;
  }
  .nav-tabs button {
    font-size: 0.85rem;
    padding: 10px;
  }
  th, td {
    font-size: 0.85rem;
  }
}
</style>

</head>

<body>
  <div class="container">
    <header>
      <div class="logo-marinha">
        <img src="<img src="https://raw.githubusercontent.com/codjr/br/main/heraldica-8DN.png" alt="Marinha do Brasil">
" alt="Marinha do Brasil">
        <h1>Administrador — Sistema de Viaturas</h1>
      </div>
      <button onclick="logout()">Sair</button>
    </header>

    <div class="nav-tabs">
      <button class="active" data-tab="tab-usuarios" onclick="setTab('tab-usuarios', this)">Usuários</button>
      <button data-tab="tab-missoes" onclick="setTab('tab-missoes', this)">Missões</button>
      <button data-tab="tab-logs" onclick="setTab('tab-logs', this)">Logs do Sistema</button>
      <button data-tab="tab-emulacao" onclick="setTab('tab-emulacao', this)">Emulação</button>
    </div>

    <!-- Usuários -->
    <section id="tab-usuarios" class="tab-pane" style="display:block;">
      <h2>Gerenciamento de Usuários</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Status</th><th style="min-width:420px">Ações</th></tr>
          </thead>
          <tbody id="usuarios-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Missões -->
    <section id="tab-missoes" class="tab-pane" style="display:none;">
      <h2>Missões (todas)</h2>
      <div class="filters">
        <select id="filtro-status" onchange="filtrarMissoes()">
          <option value="">Status: Todos</option>
          <option value="Pendente">Pendente</option>
          <option value="Aprovada pela OSE">Aprovada pela OSE</option>
          <option value="Negada pela OSE">Negada pela OSE</option>
          <option value="Em viagem">Em viagem</option>
          <option value="Concluída">Concluída</option>
        </select>
        <input id="busca-missao" type="search" placeholder="Buscar missão/viatura/motorista..." oninput="filtrarMissoes()"/>
        <span class="badge-warn">⚠ Fora da Programação aparece destacado</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Missão</th><th>Motorista</th><th>Viatura</th><th>Status</th>
              <th>Odômetro Início</th><th>Horário Início</th>
              <th>Odômetro Fim</th><th>Horário Fim</th>
              <th>Assinaturas</th>
              <th style="min-width:220px">Ações</th>
            </tr>
          </thead>
          <tbody id="missoes-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Logs -->
    <section id="tab-logs" class="tab-pane" style="display:none;">
      <h2>Logs do Sistema</h2>
      <div class="filters">
        <input id="busca-logs" type="search" placeholder="Buscar por ação, alvo, e-mail..." oninput="filtrarLogs()"/>
        <button class="reset" onclick="exportarLogs()">Exportar CSV</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Ação</th><th>Alvo</th><th>Feito por</th><th>Data/Hora</th></tr></thead>
          <tbody id="logs-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Emulação -->
    <section id="tab-emulacao" class="tab-pane" style="display:none;">
      <h2>Emulação de Perfil</h2>
      <div class="filters">
        <input id="busca-emulacao" type="search" placeholder="Buscar usuário por nome/email..." oninput="filtrarEmulacao()"/>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Ação</th></tr></thead>
          <tbody id="emulacao-body"></tbody>
        </table>
      </div>
      <p class="badge-warn" style="margin-top:8px;">⚙ Você será redirecionado ao dashboard do cargo com <b>?emulando=email</b>.</p>
    </section>
  </div>

<script type="module">
/* === Firebase Imports === */
import { auth, db } from "./firebase-config.js";
import { signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* Sessão e Logout */
const LIMITE = 10*60*1000; let t;
onAuthStateChanged(auth, async (u)=>{
  if(!u){ return window.location.href="index.html"; }
  const uDoc = await getDoc(doc(db,"usuarios", u.uid));
  if(!uDoc.exists() || uDoc.data().role!=="adm"){
    alert("Acesso permitido apenas ao Administrador.");
    await signOut(auth); return window.location.href="index.html";
  }
  init();
  reset();
  ["mousemove","keydown","click","scroll"].forEach(e=>document.addEventListener(e, reset));
});
function reset(){ clearTimeout(t); t=setTimeout(async()=>{ alert("⏰ Sessão expirada."); await signOut(auth); window.location.href="index.html"; }, LIMITE); }
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

/* Tabs */
window.setTab = (id, btn)=>{
  document.querySelectorAll(".tab-pane").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".nav-tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
};

/* Log helper */
async function logAction(acao, alvo, extra={}) {
  try {
    await addDoc(collection(db,"logs"), {
      acao, alvo,
      feito_por_uid: auth.currentUser?.uid || null,
      feito_por_email: auth.currentUser?.email || null,
      data_hora: serverTimestamp(), ...extra
    });
  } catch(e){ console.warn("Falha ao gravar log:", e); }
}

/* Inicialização */
function init(){ carregarUsuarios(); carregarMissoesRealtime(); carregarLogsRealtime(); carregarEmulacaoRealtime(); }

/* Usuários */
function carregarUsuarios(){
  const tbody = document.getElementById("usuarios-body");
  onSnapshot(collection(db,"usuarios"), (snap)=>{
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const u = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nome||"-"}</td>
        <td>${u.email||"-"}</td>
        <td>${u.role||"-"}</td>
        <td>${u.aprovado?'<span class="badge-ok">Aprovado</span>':'<span class="badge-no">Pendente</span>'}</td>
        <td class="actions">
          <button class="aprovar" onclick="aprovar('${d.id}')">✔ Aprovar</button>
          <button class="desaprovar" onclick="desaprovar('${d.id}')">✖ Desaprovar</button>
          <button class="editar" onclick="editarUsuario('${d.id}','${(u.nome||'').replace(/"/g,'&quot;')}','${u.role||''}')">✏ Editar</button>
          <button class="reset" onclick="resetSenha('${u.email||''}')">🔁 Resetar Senha</button>
          <button class="excluir" onclick="excluirUsuario('${d.id}')">🗑 Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}
window.aprovar = async(uid)=>{ await updateDoc(doc(db,"usuarios",uid), {aprovado:true}); await logAction("Aprovar usuário", uid); alert("Usuário aprovado!"); };
window.desaprovar = async(uid)=>{ await updateDoc(doc(db,"usuarios",uid), {aprovado:false}); await logAction("Desaprovar usuário", uid); alert("Usuário desaprovado!"); };
window.editarUsuario = async(uid,nomeAtual,cargoAtual)=>{ const novoNome=prompt("Novo nome:",nomeAtual)||""; const novoCargo=prompt("Novo cargo:",cargoAtual)||""; if(!novoNome||!novoCargo)return alert("Cancelado"); await updateDoc(doc(db,"usuarios",uid),{nome:novoNome,role:novoCargo}); await logAction("Editar usuário",uid,{nome:novoNome,role:novoCargo}); alert("Usuário atualizado."); };
window.resetSenha = async(email)=>{ if(!email)return alert("Usuário sem email"); try{ await sendPasswordResetEmail(auth,email); alert(`Email de redefinição enviado para ${email}`); await logAction("Reset senha",email); }catch(e){ alert("Erro ao enviar redefinição"); } };
window.excluirUsuario = async(uid)=>{ if(!confirm("Excluir usuário?"))return; await deleteDoc(doc(db,"usuarios",uid)); await logAction("Excluir usuário",uid); alert("Usuário excluído."); };

/* Missões */
let MISSOES_CACHE=[];
function carregarMissoesRealtime(){
  onSnapshot(collection(db,"viaturas_missao"),(snap)=>{
    MISSOES_CACHE=[]; snap.forEach(d=>MISSOES_CACHE.push({id:d.id,...d.data()}));
    renderMissoes(MISSOES_CACHE);
  });
}
function renderMissoes(list){
  const tbody=document.getElementById("missoes-body");
  tbody.innerHTML="";
  list.forEach(m=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${m.missao||"-"} ${m.fora_programacao?'<span class="tag-fp">⚠ Fora</span>':""}</td>
      <td>${m.motorista||"-"}</td>
      <td>${m.viatura_label||m.viatura||"-"}</td>
      <td>${m.status||"Pendente"}</td>
      <td>${m.odometro_inicio||"-"}</td>
      <td>${m.horario_inicio||"-"}</td>
      <td>${m.odometro_fim||"-"}</td>
      <td>${m.horario_fim||"-"}</td>
      <td>
        ${(m.assinatura_ose||"-")}<br>
        ${(m.assinatura_encarregado||"-")}<br>
        ${(m.assinatura_chedep||"-")}
      </td>
      <td class="actions">
        <button class="editar" onclick="editarMissao('${m.id}')">✏ Editar</button>
        <button class="reset" onclick="alterarStatus('${m.id}')">↺ Status</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
window.filtrarMissoes=()=>{ const st=document.getElementById("filtro-status").value; const q=(document.getElementById("busca-missao").value||"").toLowerCase(); renderMissoes(MISSOES_CACHE.filter(m=>{ const okSt=st?m.status===st:true; const okQ=q?(`${m.missao||""} ${m.motorista||""} ${m.viatura_label||""}`).toLowerCase().includes(q):true; return okSt&&okQ; })); };
window.editarMissao=async(id)=>{ const ref=doc(db,"viaturas_missao",id); const d=await getDoc(ref); if(!d.exists())return; const m=d.data(); const missao=prompt("Missão:",m.missao||""); if(missao===null)return; const motorista=prompt("Motorista:",m.motorista||""); const viatura_label=prompt("Viatura:",m.viatura_label||""); await updateDoc(ref,{missao,motorista,viatura_label}); await logAction("Editar missão",id); alert("Missão atualizada."); };
window.alterarStatus=async(id)=>{ const status=prompt("Novo status:",""); if(!status)return; await updateDoc(doc(db,"viaturas_missao",id),{status}); await logAction("Alterar status missão",id,{status}); alert("Status atualizado."); };

/* Logs */
let LOGS_CACHE=[];
function carregarLogsRealtime(){
  onSnapshot(query(collection(db,"logs"),orderBy("data_hora","desc")),(snap)=>{
    LOGS_CACHE=[]; const tbody=document.getElementById("logs-body"); tbody.innerHTML="";
    snap.forEach(d=>{ const l=d.data(); const row={acao:l.acao||"",alvo:l.alvo||"",feito_por:l.feito_por_email||"",data_hora:l.data_hora?.toDate?l.data_hora.toDate().toLocaleString():""}; LOGS_CACHE.push(row); const tr=document.createElement("tr"); tr.innerHTML=`<td>${row.acao}</td><td>${row.alvo}</td><td>${row.feito_por}</td><td>${row.data_hora}</td>`; tbody.appendChild(tr); });
    filtrarLogs();
  });
}
window.filtrarLogs=()=>{ const termo=(document.getElementById("busca-logs").value||"").toLowerCase(); Array.from(document.querySelectorAll("#logs-body tr")).forEach(tr=>{ tr.style.display=tr.innerText.toLowerCase().includes(termo)?"":"none"; }); };
window.exportarLogs=()=>{ if(!LOGS_CACHE.length)return alert("Sem dados."); const head=Object.keys(LOGS_CACHE[0]).join(";"); const body=LOGS_CACHE.map(r=>Object.values(r).map(v=>`"${(v??"").toString().replace(/"/g,'""')}"`).join(";")).join("\n"); const blob=new Blob([head+"\n"+body],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`logs_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url); };

/* Emulação */
function carregarEmulacaoRealtime(){
  const tbody=document.getElementById("emulacao-body");
  onSnapshot(collection(db,"usuarios"),(snap)=>{
    tbody.innerHTML=""; snap.forEach(d=>{ const u=d.data(); const tr=document.createElement("tr"); tr.innerHTML=`<td>${u.nome||"-"}</td><td>${u.email||"-"}</td><td>${u.role||"-"}</td><td><button class="editar" onclick="emularPerfil('${u.email||''}','${u.role||''}')">Emular</button></td>`; tbody.appendChild(tr); });
  });
}
window.emularPerfil=(email,role)=>{ if(!email||!role)return alert("Usuário inválido"); const destino=({adm:"adm-dashboard.html",chefe:"chefe-dashboard.html",ose:"ose-dashboard.html",encarregado:"encarregado-dashboard.html",motorista:"motorista-dashboard.html",aux_encarregado:"aux-encarregado-dashboard.html"}[role]||"index.html"); window.location.href=`${destino}?emulando=${encodeURIComponent(email)}`; };
</script>
</body>
</html>
