<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relat√≥rios - Sistema de Viaturas</title>
<link rel="icon" type="image/svg+xml" 
      href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
:root {
  --cor-primaria:#004aad;--cor-primaria-hover:#003b8e;
  --cor-fundo:#f5f7fa;--cor-texto:#1f2937;
  --cor-card:#fff;--cor-borda:#d1d5db;
  --cor-secundaria:#e2e8f0;
  --cor-sucesso:#16a34a;--cor-erro:#dc2626;--cor-aviso:#f59e0b;
}
@media(prefers-color-scheme:dark){
  :root{--cor-fundo:#0b1120;--cor-card:#111827;--cor-texto:#e5e7eb;
        --cor-borda:#1f2937;--cor-secundaria:#1e293b;}
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);
     min-height:100vh;padding:30px 10px;}
.container{max-width:1300px;margin:auto;background:var(--cor-card);
           border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.12);padding:30px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
header h1{color:var(--cor-primaria);font-size:1.5rem;margin:0;}
header button{background:var(--cor-erro);color:#fff;border:none;
              padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;}
header button:hover{background:#b91c1c;}
h2{color:var(--cor-primaria);margin-top:0;border-left:4px solid var(--cor-primaria);padding-left:10px;}
.filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
.filters input,.filters select, .filters button{
  padding:8px 12px;border:1px solid var(--cor-borda);
  border-radius:6px;background:#fff;font-size:.95rem;
}
.filters button{background:var(--cor-primaria);color:#fff;cursor:pointer;font-weight:600;}
.filters button:hover{background:var(--cor-primaria-hover);}
.table-wrap{overflow:auto;border:1px solid var(--cor-borda);border-radius:10px;}
table{width:100%;border-collapse:collapse;min-width:900px;}
thead{background:var(--cor-primaria);color:#fff;}
th,td{padding:10px 12px;border-bottom:1px solid var(--cor-borda);text-align:left;}
tbody tr:hover{background:rgba(0,74,173,.05);}
.badge-ok{background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700;}
.badge-no{background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700;}
@media(max-width:768px){.container{padding:20px;}th,td{font-size:.9rem;}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Relat√≥rios de Miss√µes</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <h2>Filtrar e Gerar Relat√≥rio</h2>
  <div class="filters">
    <select id="filtro-periodo">
      <option value="">Per√≠odo: Todos</option>
      <option value="dia">Hoje</option>
      <option value="semana">√öltimos 7 dias</option>
      <option value="mes">√öltimos 30 dias</option>
      <option value="ano">√öltimos 365 dias</option>
    </select>

    <select id="filtro-status">
      <option value="">Status: Todos</option>
      <option value="pendente">Pendente</option>
      <option value="aprovada">Aprovada</option>
      <option value="em viagem">Em viagem</option>
      <option value="conclu√≠da">Conclu√≠da</option>
    </select>

    <input id="busca" type="search" placeholder="Buscar por motorista, viatura ou miss√£o">
    <button onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
    <button onclick="exportarCSV()">Exportar CSV</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th>
          <th>Od√¥metro In√≠cio</th><th>Od√¥metro Fim</th>
          <th>Cria√ß√£o</th><th>Encerramento</th><th>Assinaturas</th>
        </tr>
      </thead>
      <tbody id="relatorio-body"></tbody>
    </table>
  </div>
</div>

<script type="module">
import {auth,db} from "./firebase-config.js";
import {signOut,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {collection,onSnapshot,query,orderBy} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* üîí Prote√ß√£o e logout autom√°tico */
const LIMITE=10*60*1000;let timer;
onAuthStateChanged(auth,u=>{
  if(!u){window.location.href="index.html";}
  else{reiniciar();["mousemove","keydown","click","scroll"].forEach(e=>document.addEventListener(e,reiniciar));}
});
function reiniciar(){clearTimeout(timer);
  timer=setTimeout(async()=>{alert("‚è∞ Sess√£o expirada.");await signOut(auth);window.location.href="index.html";},LIMITE);}
window.logout=async()=>{await signOut(auth);window.location.href="index.html";}

/* üîÑ Miss√µes em tempo real */
let MISSOES_CACHE=[];
onSnapshot(query(collection(db,"viaturas_missao"),orderBy("criada_em","desc")),snap=>{
  MISSOES_CACHE=[];snap.forEach(d=>MISSOES_CACHE.push({id:d.id,...d.data()}));
});

/* üßÆ Gerar relat√≥rio */
window.gerarRelatorio=()=>{
  try{
    const filtroStatus=(document.getElementById("filtro-status").value||"").toLowerCase();
    const filtroTexto=(document.getElementById("busca").value||"").toLowerCase();
    const periodo=document.getElementById("filtro-periodo").value;

    const hoje=new Date();
    const filtradas=MISSOES_CACHE.filter(m=>{
      const status=(m.status||"").toString().toLowerCase();
      const motorista=(m.motorista||"").toString().toLowerCase();
      const viatura=(m.viatura||"").toString().toLowerCase();
      const missao=(m.missao||"").toString().toLowerCase();
      const criadaEm=new Date(m.criada_em||Date.now());

      // filtro por data
      let dentro=true;
      if(periodo==="dia") dentro=criadaEm>new Date(hoje.getTime()-24*60*60*1000);
      if(periodo==="semana") dentro=criadaEm>new Date(hoje.getTime()-7*24*60*60*1000);
      if(periodo==="mes") dentro=criadaEm>new Date(hoje.getTime()-30*24*60*60*1000);
      if(periodo==="ano") dentro=criadaEm>new Date(hoje.getTime()-365*24*60*60*1000);

      const condStatus=!filtroStatus||status.includes(filtroStatus);
      const condBusca=!filtroTexto||
        motorista.includes(filtroTexto)||viatura.includes(filtroTexto)||missao.includes(filtroTexto);

      return condStatus&&condBusca&&dentro;
    });

    const tb=document.getElementById("relatorio-body");
    tb.innerHTML="";
    filtradas.forEach(m=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${m.missao||"-"}</td>
        <td>${m.motorista||"-"}</td>
        <td>${m.viatura||"-"}</td>
        <td>${m.status||"-"}</td>
        <td>${m.odometro_inicio||"-"}</td>
        <td>${m.odometro_fim||"-"}</td>
        <td>${m.criada_em||"-"}</td>
        <td>${m.horario_fim||"-"}</td>
        <td>
          <span class="badge-ok">OSE: ${m.assinatura_ose||"-"}</span><br>
          <span class="badge-ok">Enc: ${m.assinatura_encarregado||"-"}</span><br>
          <span class="badge-ok">Chefe: ${m.assinatura_chedep||"-"}</span>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    console.error("Erro ao gerar relat√≥rio:",e);
    alert("Erro ao gerar relat√≥rio. Veja o console.");
  }
};

/* üíæ Exportar CSV */
window.exportarCSV=()=>{
  if(!MISSOES_CACHE.length)return alert("Sem dados para exportar.");
  const linhas=[
    ["Miss√£o","Motorista","Viatura","Status","Od√¥metro In√≠cio","Od√¥metro Fim","Cria√ß√£o","Encerramento","OSE","Enc","Chefe"].join(";")
  ];
  MISSOES_CACHE.forEach(m=>{
    linhas.push([
      m.missao||"",m.motorista||"",m.viatura||"",m.status||"",
      m.odometro_inicio||"",m.odometro_fim||"",m.criada_em||"",
      m.horario_fim||"",m.assinatura_ose||"",m.assinatura_encarregado||"",m.assinatura_chedep||""
    ].map(x=>`"${(x||"").toString().replace(/"/g,'""')}"`).join(";"));
  });
  const blob=new Blob([linhas.join("\n")],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=`relatorio_viaturas_${new Date().toISOString().slice(0,10)}.csv`;a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
