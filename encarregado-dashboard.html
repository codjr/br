<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Encarregado - Dashboard</title>

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
/* ==========================================================
   UI FUTURISTA PREMIUM 2025 ‚Äî ENCARREGADO
   Azul-naval + modo escuro autom√°tico
========================================================== */
:root{
  --cor-primaria:#004aad;
  --cor-primaria-hover:#003b8e;
  --cor-sucesso:#16a34a;
  --cor-erro:#dc2626;
  --cor-aviso:#f59e0b;
  --cor-fundo:#f5f7fa;
  --cor-card:#ffffff;
  --cor-borda:#d1d5db;
  --cor-texto:#1f2937;
}
@media (prefers-color-scheme: dark){
  :root{
    --cor-fundo:#0b1120; --cor-card:#111827; --cor-texto:#e5e7eb; --cor-borda:#1f2937;
  }
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);min-height:100vh}
header{
  background:var(--cor-primaria);color:#fff;display:flex;justify-content:space-between;align-items:center;
  padding:18px 25px;box-shadow:0 2px 10px rgba(0,0,0,.2)
}
header h1{font-size:1.25rem;margin:0}
header button{
  background:#dc2626;color:#fff;border:none;border-radius:6px;padding:8px 14px;cursor:pointer;font-weight:600;transition:.25s
}
header button:hover{background:#b91c1c}
.container{
  max-width:1150px;margin:30px auto;background:var(--cor-card);padding:24px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.1)
}
h2{color:var(--cor-primaria);margin:0 0 12px;border-left:4px solid var(--cor-primaria);padding-left:10px}
form input,form select{
  width:100%;padding:10px;margin:8px 0;border:1px solid var(--cor-borda);border-radius:6px;font-size:1rem
}
form button{
  width:100%;padding:12px;background:var(--cor-primaria);color:#fff;font-weight:700;border:none;border-radius:6px;cursor:pointer;transition:.25s
}
form button:hover{background:var(--cor-primaria-hover)}
.checkbox-linha{display:flex;align-items:center;gap:8px;margin:10px 0 15px}
.checkbox-linha input{transform:scale(1.2)}

table{width:100%;border-collapse:collapse;margin-top:18px}
th,td{border-bottom:1px solid var(--cor-borda);padding:10px;text-align:left}
th{background:var(--cor-primaria);color:#fff}
tr:hover{background:rgba(0,74,173,.05)}

button.prim{background:var(--cor-primaria);color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:600}
button.prim:hover{background:var(--cor-primaria-hover)}
button.sucesso{background:var(--cor-sucesso)}
button.sucesso:hover{background:#15803d}
button.perigo{background:var(--cor-erro)}
button.perigo:hover{background:#b91c1c}

.badge-ok{background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700;display:inline-block}
.badge-no{background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700;display:inline-block}
.tag-fp{color:var(--cor-aviso);font-weight:700}

.assins small{display:block;opacity:.85}
@media (max-width: 820px){th,td{font-size:.95rem}}
</style>
</head>

<body>
<header>
  <h1>Encarregado</h1>
  <button onclick="logout()">Sair</button>
</header>

<div class="container">
  <h2>Criar Nova Miss√£o</h2>
  <form onsubmit="event.preventDefault(); criarMissao();">
    <input type="text" id="missao" placeholder="Descri√ß√£o da Miss√£o" required>
    <input type="text" id="motorista" placeholder="Motorista Respons√°vel" required>
    <input type="text" id="viatura" placeholder="Viatura (Ex: Parati E983-0987)" required>
    <div class="checkbox-linha">
      <label><input type="checkbox" id="foraProg"> Fora da Programa√ß√£o</label>
    </div>
    <button type="submit">Criar Miss√£o</button>
  </form>

  <h2>Miss√µes</h2>
  <table>
    <thead>
      <tr>
        <th>Miss√£o</th>
        <th>Motorista</th>
        <th>Viatura</th>
        <th>Status</th>
        <th>Od√¥metro In√≠cio</th>
        <th>Hor√°rio In√≠cio</th>
        <th>Od√¥metro Fim</th>
        <th>Hor√°rio Fim</th>
        <th>Assinatura P3</th>
        <th>Assinatura Encarregado</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="missoes-body"></tbody>
  </table>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
  collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* ==========================
   ‚öôÔ∏è Banner de Emula√ß√£o
========================== */
const params = new URLSearchParams(window.location.search);
const emulando = params.get("emulando");
if (emulando) {
  const aviso = document.createElement("div");
  aviso.style.position = "fixed";
  aviso.style.top = "0"; aviso.style.left = "0"; aviso.style.right = "0";
  aviso.style.zIndex = "9999"; aviso.style.padding = "12px 20px";
  aviso.style.textAlign = "center"; aviso.style.fontWeight = "600";
  aviso.style.color = "#fff";
  aviso.style.background = "linear-gradient(90deg, #004aad, #007bff)";
  aviso.style.boxShadow = "0 3px 8px rgba(0,0,0,0.25)";
  aviso.innerHTML = `‚öôÔ∏è EMULANDO perfil de <b>${emulando}</b>
    <button id="sairEmulacao" style="margin-left:10px;background:#dc2626;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-weight:600;">Encerrar Emula√ß√£o</button>`;
  document.body.prepend(aviso);
  document.body.style.marginTop = "60px";
  document.getElementById("sairEmulacao").onclick = () => window.location.href = "adm-dashboard.html";
}

/* ==========================
   üîê Sess√£o / Logout
========================== */
window.logout = async()=>{ await signOut(auth); window.location.href="index.html"; };

/* ==========================
   ‚ûï Criar miss√£o
========================== */
window.criarMissao = async()=>{
  const missao = document.getElementById("missao").value.trim();
  const motorista = document.getElementById("motorista").value.trim();
  const viatura = document.getElementById("viatura").value.trim();
  const foraProg = document.getElementById("foraProg").checked;

  if(!missao || !motorista || !viatura){ return alert("‚ö†Ô∏è Preencha todos os campos."); }

  try{
    await addDoc(collection(db,"viaturas_missao"),{
      missao, motorista, viatura,
      status:"Pendente",
      criada_por: auth.currentUser?.email || "encarregado",
      criada_em: serverTimestamp(),
      programada: !foraProg,
      fora_programacao: foraProg,
      // campos operacionais:
      odometro_inicio: "", horario_inicio: "",
      odometro_fim: "",    horario_fim:   "",
      // assinaturas:
      confirmado_p3:false, assinatura_p3:"", hora_confirmacao_p3:"",
      assinada_encarregado:false, assinatura_encarregado:"", horario_assinatura_encarregado:"",
      assinada_ose:false, assinada_motorista:false
    });
    alert(foraProg ? "üö® Miss√£o fora da programa√ß√£o criada!" : "‚úÖ Miss√£o criada com sucesso!");
    document.querySelector("form").reset();
  }catch(e){ console.error(e); alert("‚ùå Erro ao criar miss√£o."); }
};

/* ==========================
   üì° Listagem em tempo real
========================== */
onSnapshot(collection(db,"viaturas_missao"),(snapshot)=>{
  const tbody = document.getElementById("missoes-body");
  tbody.innerHTML = "";
  snapshot.forEach(docItem=>{
    const d = docItem.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.missao||"-"} ${d.fora_programacao?`<span class="tag-fp">‚ö† Fora da Programa√ß√£o</span>`:""}</td>
      <td>${d.motorista||"-"}</td>
      <td>${d.viatura||"-"}</td>
      <td>${d.status||"-"}</td>
      <td>${d.odometro_inicio||"-"}</td>
      <td>${d.horario_inicio||"-"}</td>
      <td>${d.odometro_fim||"-"}</td>
      <td>${d.horario_fim||"-"}</td>
      <td class="assins">${
        d.confirmado_p3
          ? `<span class="badge-ok">${d.assinatura_p3 || "P3 assinado"}</span><small>${d.hora_confirmacao_p3||""}</small>`
          : `<span class="badge-no">Pendente P3</span>`
      }</td>
      <td class="assins">${
        d.assinada_encarregado
          ? `<span class="badge-ok">Assinado</span><small>${d.assinatura_encarregado||""} ${d.horario_assinatura_encarregado?("<br>"+d.horario_assinatura_encarregado):""}</small>`
          : `<span class="badge-no">Pendente</span>`
      }</td>
      <td>
        ${d.assinada_encarregado
          ? `<button class="prim" disabled>Assinado</button>`
          : `<button class="prim sucesso" onclick="assinar('${docItem.id}')">Assinar</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
});

/* ==========================
   ‚úçÔ∏è Assinatura do Encarregado
========================== */
window.assinar = async(id)=>{
  try{
    await updateDoc(doc(db,"viaturas_missao",id),{
      assinada_encarregado:true,
      assinatura_encarregado: auth.currentUser?.email || "encarregado",
      horario_assinatura_encarregado: new Date().toLocaleString()
    });
    alert("‚úçÔ∏è Assinatura registrada com sucesso!");
  }catch(e){ console.error(e); alert("‚ùå Erro ao assinar miss√£o."); }
};
</script>
</body>
</html>
