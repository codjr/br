<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encarregado - Dashboard</title>
<link rel="icon" type="image/svg+xml" 
      href="https://upload.wikimedia.org/wikipedia/commons/a/ad/Coat_of_arms_of_the_Brazilian_Navy.svg">

<style>
:root {
  --cor-primaria:#004aad;--cor-primaria-hover:#003b8e;
  --cor-fundo:#f5f7fa;--cor-texto:#1f2937;
  --cor-card:#fff;--cor-borda:#d1d5db;
  --cor-secundaria:#e2e8f0;
  --cor-sucesso:#16a34a;--cor-erro:#dc2626;--cor-aviso:#f59e0b;
}
@media(prefers-color-scheme:dark){
  :root{--cor-fundo:#0b1120;--cor-card:#111827;--cor-texto:#e5e7eb;
        --cor-borda:#1f2937;--cor-secundaria:#1e293b;}
}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--cor-fundo);color:var(--cor-texto);
     min-height:100vh;padding:30px 10px;}
.container{max-width:1200px;margin:auto;background:var(--cor-card);
           border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.12);padding:30px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
header h1{color:var(--cor-primaria);font-size:1.5rem;margin:0;}
header button{background:var(--cor-erro);color:#fff;border:none;
              padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;}
header button:hover{background:#b91c1c;}
h2{color:var(--cor-primaria);margin-top:0;border-left:4px solid var(--cor-primaria);padding-left:10px;}
nav.menu{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:25px;}
nav.menu a{background:var(--cor-primaria);color:#fff;text-decoration:none;
           padding:10px 18px;border-radius:6px;font-weight:600;transition:.3s;}
nav.menu a:hover{background:var(--cor-primaria-hover);}
form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:25px;}
form input, form select{padding:10px;border:1px solid var(--cor-borda);
           border-radius:6px;font-size:1rem;flex:1 1 200px;}
button{border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;}
button.criar{background:var(--cor-primaria);color:#fff;}
button.criar:hover{background:var(--cor-primaria-hover);}
button.assinar{background:var(--cor-sucesso);color:#fff;}
button.assinar:hover{background:#15803d;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
thead{background:var(--cor-primaria);color:#fff;}
th,td{padding:10px 12px;border-bottom:1px solid var(--cor-borda);text-align:left;}
tbody tr:hover{background:rgba(0,74,173,.05);}
.badge-ok{background:rgba(22,163,74,.12);color:#166534;padding:4px 8px;border-radius:6px;font-weight:700;}
.badge-no{background:rgba(220,38,38,.12);color:#991b1b;padding:4px 8px;border-radius:6px;font-weight:700;}
.tag-fp{color:#dc2626;font-weight:700;}
@media(max-width:768px){.container{padding:20px;}th,td{font-size:.9rem;}}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Encarregado - Dashboard</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <!-- üîó MENU DE ACESSO R√ÅPIDO -->
  <nav class="menu">
    <a href="gerenciar-viaturas.html">üöó Cadastrar/Editar Viaturas</a>
    <a href="relatorios.html">üìä Relat√≥rios</a>
  </nav>

  <h2>Criar Nova Miss√£o</h2>
  <form onsubmit="event.preventDefault(); criarMissao();">
    <input type="text" id="missao" placeholder="Miss√£o" required>

    <select id="motorista" required>
      <option value="">Selecione o Motorista</option>
    </select>

    <select id="viatura" required onchange="carregarOdometro()">
      <option value="">Selecione a Viatura</option>
    </select>

    <input type="number" id="odometro_inicio" placeholder="Od√¥metro Inicial (auto)" readonly>
    <button type="submit" class="criar">Criar Miss√£o</button>
  </form>

  <h2>Miss√µes Existentes</h2>
  <table>
    <thead>
      <tr>
        <th>Miss√£o</th><th>Motorista</th><th>Viatura</th><th>Status</th>
        <th>Od√¥metro In√≠cio</th><th>Od√¥metro Fim</th><th>Assinaturas</th><th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="missoes-body"></tbody>
  </table>
</div>

<script type="module">
import {auth,db} from "./firebase-config.js";
import {signOut,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {collection,query,where,getDocs,onSnapshot,addDoc,updateDoc,doc,serverTimestamp} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

/* üîí Prote√ß√£o + Logout autom√°tico */
const LIMITE=10*60*1000;let timer;
onAuthStateChanged(auth,u=>{
  if(!u){window.location.href="index.html";}
  else{
    resetar();carregarMotoristas();carregarViaturas();carregarMissoes();
    ["mousemove","keydown","click","scroll"].forEach(e=>document.addEventListener(e,resetar));
  }
});
function resetar(){clearTimeout(timer);
  timer=setTimeout(async()=>{alert("‚è∞ Sess√£o expirada.");await signOut(auth);window.location.href="index.html";},LIMITE);}
window.logout=async()=>{await signOut(auth);window.location.href="index.html";}

/* üöó Carregar viaturas cadastradas */
async function carregarViaturas(){
  const sel=document.getElementById("viatura");
  sel.innerHTML="<option value=''>Selecione a Viatura</option>";
  const snap=await getDocs(collection(db,"viaturas"));
  snap.forEach(v=>{
    const d=v.data();
    const opt=document.createElement("option");
    opt.value=v.id;
    opt.textContent=`${d.identificacao} (${d.modelo})`;
    sel.appendChild(opt);
  });
}

/* üë§ Carregar motoristas cadastrados */
async function carregarMotoristas(){
  const sel=document.getElementById("motorista");
  sel.innerHTML="<option value=''>Selecione o Motorista</option>";
  const q=query(collection(db,"usuarios"),where("role","==","motorista"),where("aprovado","==",true));
  const snap=await getDocs(q);
  snap.forEach(u=>{
    const d=u.data();
    const opt=document.createElement("option");
    opt.value=d.email;
    opt.textContent=d.nome+" ("+d.email+")";
    sel.appendChild(opt);
  });
}

/* üìä Carregar miss√µes */
function carregarMissoes(){
  const tb=document.getElementById("missoes-body");
  onSnapshot(collection(db,"viaturas_missao"),snap=>{
    tb.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${m.missao||""}</td>
        <td>${m.motorista||""}</td>
        <td>${m.viatura_nome||""}</td>
        <td>${m.status||"Pendente"}</td>
        <td>${m.odometro_inicio||"-"}</td>
        <td>${m.odometro_fim||"-"}</td>
        <td>
          <small>OSE: ${m.assinatura_ose||"-"}</small><br>
          <small>Enc: ${m.assinatura_encarregado||"-"}</small><br>
          <small>Chefe: ${m.assinatura_chedep||"-"}</small>
        </td>
        <td><button class='assinar' onclick="assinar('${d.id}')">Assinar</button></td>`;
      tb.appendChild(tr);
    });
  });
}

/* üî¢ Puxar od√¥metro da viatura */
window.carregarOdometro=async()=>{
  const id=document.getElementById("viatura").value;
  if(!id)return;
  const snap=await getDocs(collection(db,"viaturas"));
  snap.forEach(v=>{
    if(v.id===id){
      const d=v.data();
      document.getElementById("odometro_inicio").value=d.odometro_final||d.odometro_atual||0;
    }
  });
};

/* üÜï Criar miss√£o */
window.criarMissao=async()=>{
  const missao=document.getElementById("missao").value.trim();
  const motorista=document.getElementById("motorista").value;
  const viaturaId=document.getElementById("viatura").value;
  const viaturaSel=document.getElementById("viatura");
  const viaturaNome=viaturaSel.options[viaturaSel.selectedIndex].textContent;
  const odometro=parseInt(document.getElementById("odometro_inicio").value);
  if(!missao||!motorista||!viaturaId){alert("Preencha todos os campos.");return;}

  await addDoc(collection(db,"viaturas_missao"),{
    missao,
    motorista,
    viatura:viaturaId,
    viatura_nome:viaturaNome,
    odometro_inicio:odometro,
    status:"Pendente",
    criada_por:auth.currentUser?.email||"encarregado",
    criada_em:serverTimestamp()
  });
  alert("‚úÖ Miss√£o criada com sucesso!");
  document.querySelector("form").reset();
};

/* ‚úçÔ∏è Assinar miss√£o */
window.assinar=async(id)=>{
  await updateDoc(doc(db,"viaturas_missao",id),{
    assinatura_encarregado:auth.currentUser?.email||"encarregado",
    hora_assinatura_encarregado:new Date().toLocaleString(),
    status:"Assinada pelo Encarregado",
    atualizado_em:serverTimestamp()
  });
  alert("‚úç Miss√£o assinada com sucesso!");
};
</script>
</body>
</html>
